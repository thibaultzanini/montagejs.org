function readStart(){console.error("readStart"),reading=!0}function readStop(){console.error("readStop"),reading=!1,process.nextTick(function(){var e=stream.read();null!==e&&writer.write(e)})}function data(){assert(reading),source.emit("data",chunk),assert(reading),source.emit("data",chunk),assert(reading),source.emit("data",chunk),assert(reading),source.emit("data",chunk),assert(!reading),5>set++?setTimeout(data,10):end()}function finish(){console.error("finish"),assert.deepEqual(written,expectWritten),console.log("ok")}function end(){source.emit("end"),assert(!reading),writer.end(stream.read()),setTimeout(function(){assert(ended)})}var common=require("../common.js"),stream=require("../../readable"),Readable=stream.Readable,Writable=stream.Writable,assert=require("assert"),util=require("util"),EE=require("events").EventEmitter,stream=new Readable({highWaterMark:16,encoding:"utf8"}),source=new EE;stream._read=function(){console.error("stream._read"),readStart()};var ended=!1;stream.on("end",function(){ended=!0}),source.on("data",function(e){var t=stream.push(e);console.error("data",stream._readableState.length),t||readStop()}),source.on("end",function(){stream.push(null)});var reading=!1,writer=new Writable({decodeStrings:!1}),written=[],expectWritten=["asdfgasdfgasdfgasdfg","asdfgasdfgasdfgasdfg","asdfgasdfgasdfgasdfg","asdfgasdfgasdfgasdfg","asdfgasdfgasdfgasdfg","asdfgasdfgasdfgasdfg"];writer._write=function(e,t,n){console.error("WRITE %s",e),written.push(e),process.nextTick(n)},writer.on("finish",finish);var chunk="asdfg",set=0;readStart(),data();