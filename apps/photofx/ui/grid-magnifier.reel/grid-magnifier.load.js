montageDefine("a005228","ui/grid-magnifier.reel/grid-magnifier",{dependencies:["montage","montage/ui/component","montage/ui/dom","montage/core/geometry/point"],factory:function(e,t,n){var r=e("montage").Montage,i=e("montage/ui/component").Component,s=e("montage/ui/dom"),o=e("montage/core/geometry/point").Point;t.GridMagnifier=r.create(i,{_loupe:{value:null,serializable:!0},_canvas:{value:null},_grid:{value:null},grid:{get:function(){return this._grid},set:function(e){if(e===this._grid)return;this._grid=e,this.needsDraw=!0}},_width:{value:null},_height:{value:null},_pageCenterX:{value:null},_pageCenterY:{value:null},x:{value:null},y:{value:null},color:{value:null},colorPickerEnabled:{value:!1},handleColorpick:{value:function(e){this._pageCenterX=e.pageX,this._pageCenterY=e.pageY,this.x=e.canvasX,this.y=e.canvasY,this.grid=e.focusGrid,this.color=e.color,document.application.addEventListener("colorpickend",this,!1)}},handleColorpickend:{value:function(){document.application.removeEventListener("colorpickend",this,!1),this._pageCenterX=null,this._pageCenterY=null,this.grid=null}},_followPointer:{value:!1,serializable:!0},followPointer:{get:function(){return this._followPointer},set:function(e){if(e===this._followPointer)return;this._followPointer=e,this.needsDraw=!0}},prepareForDraw:{value:function(){document.application.addEventListener("colorpick",this,!1);var e=this._canvas.cloneNode(!0);this._canvas.parentNode.replaceChild(e,this._canvas),this._canvas=e,this._context=this._canvas.getContext("2d")}},willDraw:{value:function(){this._width=this._loupe.offsetWidth,this._height=this._loupe.offsetHeight}},draw:{value:function(){if(!this._width||!this._height||!this.grid){this.element.classList.remove("active");return}this.element.classList.add("active"),this.followPointer?this.element.classList.remove("stationary"):this.element.classList.add("stationary");var e=10,t=this._pageCenterX-this._width/2-e/2,n=this._pageCenterY-this._height/2-e/2,r=s.convertPointFromPageToNode(this.element.parentNode,o.create().init(t,n)),i=this.grid.data,u=this._context,a,f,l=0,c=Math.floor(this._width/e),h=Math.floor(this._height/e);this.followPointer?this.element.style.webkitTransform="translate3d("+r.x+"px, "+r.y+"px , 0)":this.element.style.webkitTransform="translate3d(0, 0, 0)",u.clearRect(0,0,this._width,this._height);for(f=0;f<c;f++)for(a=0;a<h;a++)u.fillStyle="rgba("+i[l]+","+i[l+1]+","+i[l+2]+","+i[l+3]+")",u.fillRect(a*e,f*e,e,e),l+=4;u.globalAlpha=.1,u.globalCompositeOperation="xor",u.strokeStyle="#000",u.lineWidth=1,u.beginPath();for(a=0;a<=this._width;a+=e)u.moveTo(a,0),u.lineTo(a,this._height);for(f=0;f<=this._height;f+=e)u.moveTo(0,f),u.lineTo(this._width,f);u.stroke(),u.closePath(),u.globalAlpha=1,u.globalCompositeOperation="source-over",u.strokeRect(Math.floor(h/2)*e,Math.floor(c/2)*e,e,e)}}})}})