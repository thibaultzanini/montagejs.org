var Montage=require("montage").Montage,Component=require("montage/ui/component").Component,ArrayController=require("montage/ui/controller/array-controller").ArrayController,PointMonitor=require("core/point-monitor").PointMonitor,undoManager=require("montage/core/undo-manager").defaultUndoManager,Promise=require("montage/core/promise").Promise;exports.ColorInfoPanel=Montage.create(Component,{didCreate:{value:function(){this.pointMonitorController=ArrayController.create(),this.pointMonitorController.content=[],this.pointMonitorController.objectPrototype=PointMonitor;for(var e=0;e<2;e++)this.pointMonitorController.add();this.pointMonitorController.selectedIndexes=[0],this.pointMonitorController.selectObjectsOnAddition=!0}},_editor:{enumerable:!1,value:null},editor:{get:function(){return this._editor},set:function(e){var t=this._editor;if(e===t)return;t&&(t.pointMonitorController=null,t.removeEventListener("colorpick",this,!1),t.removeEventListener("colorpickend",this,!1),t.removeEventListener("imagemodified",this,!1)),this._editor=e,e&&(e.pointMonitorController=this.pointMonitorController,e.addEventListener("colorpick",this,!1),e.addEventListener("colorpickend",this,!1),e.addEventListener("imagemodified",this,!1))}},handleColorpick:{value:function(e){var t=this.pointMonitorController.getProperty("selectedObjects.0");t&&this.pickColor(t,e.canvasX,e.canvasY,e.color,!1)}},handleColorpickend:{value:function(e){var t=this.pointMonitorController.getProperty("selectedObjects.0");t&&this.pickColor(t,e.canvasX,e.canvasY,e.color,!0)}},pickColor:{value:function(e,t,n,r,i){this._undoColorPickInfo||(this._undoColorPickInfo={x:e.x,y:e.y}),e.x=t,e.y=n,!r&&(null!=t||null!=n)&&(r=this.editor.dataAtPoint(t,n)),e.color=r;if(i){var s=this._undoColorPickInfo.x,o=this._undoColorPickInfo.y;(s!==t||o!==n)&&undoManager.register("set marker location",Promise.resolve([this.pickColor,this,e,s,o,null,!0])),this._undoColorPickInfo=null}}},handleImagemodified:{value:function(e){var t=this.getProperty("pointMonitorController.organizedObjects"),n=e.detail.editor,r,i;if(!t||n!==this._editor)return;for(r=0;i=t[r];r++)null!=i.x&&null!=i.y&&(i.color=n.dataAtPoint(i.x,i.y))}},handleAddMonitorButtonAction:{value:function(){this.addPointMonitors()}},handleRemoveMonitorButtonAction:{value:function(){this.removePointMonitors()}},addPointMonitors:{value:function(e){var t=this.pointMonitorController;undoManager.isUndoing&&(t.selectObjectsOnAddition=!1),e?t.addObjects.apply(t,e):t.add(),undoManager.register("add color marker",Promise.resolve([this.removePointMonitors,this,[t.organizedObjects.length-1]])),undoManager.isUndoing&&(t.selectObjectsOnAddition=!0)}},removePointMonitors:{value:function(e){var t;if(e)t=this.pointMonitorController.removeObjectsAtIndexes(e);else{var n=this.pointMonitorController.selectedIndexes[0],r;t=this.pointMonitorController.remove(),r=this.pointMonitorController.organizedObjects.length,!this.pointMonitorController.selectedIndexes.length&&r>n?this.pointMonitorController.selectedIndexes=[n]:this.pointMonitorController.selectedIndexes=[n-1]}t&&t.length>0&&undoManager.register("remove color marker",Promise.resolve([this.addPointMonitors,this,t]))}}})