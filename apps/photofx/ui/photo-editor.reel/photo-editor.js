var Montage=require("montage").Montage,Component=require("montage/ui/component").Component,dom=require("montage/ui/dom"),Point=require("montage/core/geometry/point").Point,DesaturateEffect=require("core/effect/desaturate-effect").DesaturateEffect,InvertEffect=require("core/effect/invert-effect").InvertEffect,SepiaEffect=require("core/effect/sepia-effect").SepiaEffect,MultiplyEffect=require("core/effect/multiply-effect").MultiplyEffect,CORS_TEST_IMAGE="https://lh5.googleusercontent.com/-M9uCIhQjy3c/TwTSfmO6MlI/AAAAAAAAFcw/BIMvbz3a7Z4/s1/blank.jpg";exports.PhotoEditor=Montage.create(Component,{supportsCrossOriginCanvas:{value:null},didCreate:{value:function(){this._testCrossOriginCanvas()}},_testCrossOriginCanvas:{value:function(){var e,t,n,r=this;e=document.createElement("img"),e.crossOrigin="",e.src=CORS_TEST_IMAGE,e.onload=function(){t=document.createElement("canvas"),n=t.getContext("2d"),n.drawImage(e,0,0,1,1);try{n.getImageData(0,0,1,1),r.supportsCrossOriginCanvas=!0}catch(i){if(18!==i.code)throw i;r.supportsCrossOriginCanvas=!1}}}},__image:{value:null},_image:{get:function(){return this.__image},set:function(e){if(this.__image===e)return;this.__image&&this.__image.element.removeEventListener("load",this,!1),this.__image=e,this.__image.element.identifier="editorImage",this.__image&&this.__image.element.addEventListener("load",this,!1)}},_canvas:{value:null},_toolLayer:{value:null},_pointerIdentifier:{value:null},prepareForActivationEvents:{value:function(){window.Touch?this._canvas.addEventListener("touchstart",this,!1):this._canvas.addEventListener("mousedown",this,!1)}},handleMousedown:{value:function(e){if(e.button!==0)return;e.preventDefault(),this._pointerIdentifier="mouse",document.addEventListener("mousemove",this,!1),document.addEventListener("mouseup",this,!1),this._pickColor(e.pageX,e.pageY);var t=dom.convertPointFromPageToNode(this._canvas,Point.create().init(e.pageX,e.pageY));this.horizontalRuler&&(this.horizontalRuler.savedPosition=t.x),this.verticalRuler&&(this.verticalRuler.savedPosition=t.y),this.needsDraw=!0}},handleTouchstart:{value:function(e){if(this._pointerIdentifier)return;e.preventDefault();var t=e.changedTouches[0];this._pointerIdentifier=t.identifier,this._canvas.addEventListener("touchmove",this,!1),document.addEventListener("touchend",this,!1),document.addEventListener("touchcancel",this,!1),this._pickColor(t.pageX,t.pageY)}},handleMouseup:{value:function(e){if(e.button!==0)return;this._pointerIdentifier=null,document.removeEventListener("mousemove",this,!1),document.removeEventListener("mouseup",this,!1),this._pickColor(e.pageX,e.pageY,!0),this.horizontalRuler&&(this.horizontalRuler.savedPosition=null),this.verticalRuler&&(this.verticalRuler.savedPosition=null),this.needsDraw=!0}},handleMousemove:{value:function(e){if(!this._pointerIdentifier)return;this._pickColor(e.pageX,e.pageY)}},handleTouchmove:{value:function(e){var t=0,n,r=null;for(;n=e.changedTouches[t];t++)if(n.identifier===this._pointerIdentifier){r=n;break}if(!r)return;this._pickColor(r.pageX,r.pageY)}},handleTouchend:{value:function(){var e=0,t,n=null;for(;t=event.changedTouches[e];e++)if(t.identifier===this._pointerIdentifier){n=t;break}if(!n)return;this._pointerIdentifier=null,this._pickColor(n.pageX,n.pageY,!0)}},_pickColor:{value:function(e,t,n){var r=20,i=10,s=this._canvas,o=s.getContext("2d"),u=dom.convertPointFromPageToNode(s,Point.create().init(e,t)),a=o.getImageData(u.x,u.y,1,1),f=o.getImageData(u.x-i,u.y-i,r,r),l;l=document.createEvent("CustomEvent"),l.initCustomEvent(n?"colorpickend":"colorpick",!0,!0,null),l.color=[a.data[0],a.data[1],a.data[2],a.data[3]],l.focusGrid=f,l.pageX=e,l.pageY=t,l.canvasX=u.x,l.canvasY=u.y,this.dispatchEvent(l)}},dataAtPoint:{value:function(e,t){if(!this.hasImage||!this._canvas||e<0||e>this._width||t<0||t>this._height)return null;var n=this._canvas,r=n.getContext("2d"),i=r.getImageData(e,t,1,1).data;return[i[0],i[1],i[2],i[3]]}},_photo:{value:null},photo:{get:function(){return this._photo},set:function(e){if(e===this._photo)return;this._photo=e,this._photo||(this.hasImage=!1,this.needsDraw=!0)}},hasImage:{value:!1},handleEditorImageLoad:{value:function(e){this._imageDirty=!0,this.hasImage=!0,this.needsDraw=!0}},_width:{value:null},_height:{value:null},currentColor:{value:null},_inverted:{value:!1},inverted:{get:function(){return this._inverted},set:function(e){if(e===this._inverted)return;this._inverted=e,this._imageDirty=!0,this.needsDraw=!0}},_desaturated:{value:!1},desaturated:{get:function(){return this._desaturated},set:function(e){if(e===this._desaturated)return;this._desaturated=e,this._imageDirty=!0,this.needsDraw=!0}},_sepiaToned:{value:!1},sepiaToned:{get:function(){return this._sepiaToned},set:function(e){if(e===this._sepiaToned)return;this._sepiaToned=e,this._imageDirty=!0,this.needsDraw=!0}},_multiplyEffect:{value:!1},multiplyEffect:{get:function(){return this._multiplyEffect},set:function(e){if(e===this._multiplyEffect)return;this._multiplyEffect=e,this._imageDirty=!0,this.needsDraw=!0}},_multiplyMultiplier:{value:1},multiplyMultiplier:{get:function(){return this._multiplyMultiplier},set:function(e){if(e===this._multiplyMultiplier)return;this._multiplyMultiplier=e,this.multiplyEffect&&(this._imageDirty=!0,this.needsDraw=!0)}},prepareForDraw:{value:function(){this._image.element.crossOrigin="";var e=this._canvas.cloneNode(!0);this._canvas.parentNode.replaceChild(e,this._canvas),this._canvas=e}},horizontalRuler:{value:null},verticalRuler:{value:null},pointMonitorController:{value:null},_isShowingPointMonitors:{value:null},isShowingPointMonitors:{get:function(){return this._isShowingPointMonitors},set:function(e){if(e===this._isShowingPointMonitors)return;this._isShowingPointMonitors=e,this.needsDraw=!0}},willDraw:{value:function(){this._width=this._image.element.offsetWidth,this._height=this._image.element.offsetHeight}},draw:{value:function(){if(!this._width||!this._height)return;var e=this._width,t=this._height,n,r,i;this._toolLayer.style.width=e+"px",this._toolLayer.style.height=t+"px",this._isShowingPointMonitors?this.element.classList.add("isShowingPointMonitors"):this.element.classList.remove("isShowingPointMonitors"),this._pointerIdentifier?this.element.classList.add("pickingColor"):this.element.classList.remove("pickingColor"),this.hasImage?this.element.classList.add("hasImage"):this.element.classList.remove("hasImage");if(!this._imageDirty)return;n=this._canvas,r=this._image.element,i,n.width=e,n.height=t,i=n.getContext("2d"),i.drawImage(r,0,0);var s=i.getImageData(0,0,e,t),o=s.data,u=o.length;this.inverted&&InvertEffect.applyEffect(o,u),this.desaturated&&DesaturateEffect.applyEffect(o,u),this.sepiaToned&&SepiaEffect.applyEffect(o,u),this.multiplyEffect&&MultiplyEffect.applyEffect(o,u,this.multiplyMultiplier),i.putImageData(s,0,0)}},didDraw:{value:function(){if(this._imageDirty){var e=document.createEvent("CustomEvent");e.initCustomEvent("imagemodified",!0,!0,{editor:this}),this.dispatchEvent(e),this._imageDirty=!1}}}})