var Montage=require("montage").Montage,Component=require("montage/ui/component").Component,Popup=require("montage/ui/popup/popup.reel").Popup,Serializer=require("montage/core/serializer").Serializer,Deserializer=require("montage/core/deserializer").Deserializer,defaultUndoManager=require("montage/core/undo-manager").defaultUndoManager,ArrayController=require("montage/ui/controller/array-controller").ArrayController,LOCAL_STORAGE_KEY="montage_photofx_state",Promise=require("montage/core/promise").Promise;exports.Main=Montage.create(Component,{didCreate:{value:function(){this.undoManager=defaultUndoManager,this.photoController=ArrayController.create(),this._loadPhotos()}},_loadPhotos:{value:function(){var e,t,n;if(localStorage){e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){t=Deserializer.create(),n=this;try{t.initWithStringAndRequire(e,require).deserializeObject(function(e){n.photoController.content=e.photos},require)}catch(r){console.error("Could not load saved state."),console.debug("Could not deserialize",e),console.log(r.stack)}}}!this.photoController.content&&!e&&(this.photoController.content=[{src:"images/IMG_1337.jpg",thumbnailSrc:"images/IMG_1337_thumb.jpg",title:"Piston",authors:["mike"],id:"4692177F-8C28-4273-99A5-DB453EF2767C"},{src:"images/IMG_1375.jpg",thumbnailSrc:"images/IMG_1375_thumb.jpg",title:"Big Sky",authors:["mike"],id:"89C81183-BB4C-4FAB-93B2-F193A54FF8CF"},{src:"images/IMG_1414.jpg",thumbnailSrc:"images/IMG_1414_thumb.jpg",title:"5771",authors:["mike"],id:"9797A89D-6EC6-4AC1-A568-87A42D04915A"},{src:"images/IMG_1416.jpg",thumbnailSrc:"images/IMG_1416_thumb.jpg",title:"Horizon",authors:["mike"],id:"61E19879-7E28-4D53-AECE-F1D80D9EDE0A"}])}},_testCrossOriginCanvas:{value:function(){var e,t,n,r=this;e=document.createElement("img"),e.crossOrigin="",e.src=CORS_TEST_IMAGE,e.onload=function(){t=document.createElement("canvas"),n=t.getContext("2d"),n.drawImage(e,0,0,1,1);try{n.getImageData(0,0,1,1),r.supportsCrossOriginCanvas=!0}catch(i){if(18!==i.code)throw i;r.supportsCrossOriginCanvas=!1}}}},photoController:{value:null},prepareForDraw:{value:function(){document.addEventListener("mousedown",this,!1),window.addEventListener("beforeunload",this,!0),this.element.addEventListener("dragenter",this,!1),this.element.addEventListener("dragleave",this,!1),this.element.addEventListener("dragover",this,!1),this.element.addEventListener("drop",this,!1),this.element.addEventListener("dragend",this,!1),window.Touch&&this.element.classList.add("touch")}},handleMousedown:{value:function(e){e.button===1&&(this.showControls=!this._showControls)}},_showControls:{value:!0},showControls:{get:function(){return this._showControls},set:function(e){if(e===this._showControls)return;this._showControls=e,this.needsDraw=!0}},handleDragenter:{value:function(e){e.dataTransfer.types.indexOf("Files")>=0?this.willingToAcceptDrop=!0:(e.dataTransfer.effectAllowed="none",e.dataTransfer.dropEffect="none")}},handleDragleave:{value:function(e){this.willingToAcceptDrop=!1}},handleDragover:{value:function(e){e.preventDefault()}},handleDrop:{value:function(e){e.stopPropagation(),e.preventDefault();if(!this.willingToAcceptDrop)return;var t=e.dataTransfer.files,n,r;for(n=0;r=t[n];n++){if(!r.type.match(/image.*/))continue;var i=new FileReader;i.onload=function(e,t){return function(n){var r={src:n.target.result,title:t.name};e.photoController.addObjects(r)}}(this,r),i.readAsDataURL(r)}}},handleDragend:{value:function(e){this.willingToAcceptDrop=!1}},_willingToAcceptDrop:{value:!1},willingToAcceptDrop:{get:function(){return this._willingToAcceptDrop},set:function(e){if(e===this._willingToAcceptDrop)return;this._willingToAcceptDrop=e,this.needsDraw=!0}},captureBeforeunload:{value:function(){this.saveState()}},saveState:{value:function(){if(!localStorage)return;var e={photos:this.photoController.organizedObjects},t=Serializer.create().initWithRequire(require);localStorage.setItem(LOCAL_STORAGE_KEY,t.serializeObject(e))}},searchPanel:{value:null},photoEditor:{value:null},searchPopup:{value:null},handleAddPhotosButtonAction:{value:function(){if(!this.photoEditor.supportsCrossOriginCanvas)return;var e=this.searchPopup;e||(e=Popup.create(),e.content=this.searchPanel,this.searchPopup=e),e.show()}},handleRemovePhotoButtonAction:{value:function(){if(!this.photoEditor.supportsCrossOriginCanvas)return;var e=this.photoController.getProperty("selectedObjects.0");if(!e)return;var t=this.photoController.content.indexOf(e);this.removePhotoAtIndex(t)}},handleUndoButtonAction:{value:function(){this.undoManager.undo()}},handleRedoButtonAction:{value:function(){this.undoManager.redo()}},removePhotoAtIndex:{value:function(e){var t=this.photoController.content[e],n='remove photo "'+t.title+'"';this.undoManager.register(n,Promise.resolve([this.addPhotoAtIndex,this,t,e])),this.photoController.removeObjects(t)}},addPhotoAtIndex:{value:function(e,t){var n='add photo "'+e.title+'"';this.undoManager.register(n,Promise.resolve([this.removePhotoAtIndex,this,t])),this.photoController.content.splice(t,0,e),this.photoController.selectedObjects=[e]}},draw:{value:function(){this.showControls?this.element.classList.add("showControls"):this.element.classList.remove("showControls"),this.willingToAcceptDrop?this.element.classList.add("acceptsDrop"):this.element.classList.remove("acceptsDrop")}}})