var Montage=require("montage").Montage,ChangeNotification=require("core/change-notification").ChangeNotification,Serializer=require("core/serializer").Serializer,Deserializer=require("core/deserializer").Deserializer,logger=require("core/logger").logger("binding"),defaultEventManager=require("core/event/event-manager").defaultEventManager,AT_TARGET=2,UNDERSCORE="_",ChangeEventDispatchingArray=exports.ChangeEventDispatchingArray=[],PropertyChangeBindingListener=exports.PropertyChangeBindingListener=Object.create(Montage,{useCapture:{value:!1,writable:!0},target:{value:null,writable:!0},originalListener:{value:null,writable:!0},originalListenerIsFunction:{value:!1,writable:!0},targetPropertyPath:{value:null,writable:!0},bindingOriginValueDeferred:{value:!1,writable:!0},deferredValue:{value:null,writable:!0},deferredValueTarget:{value:null,writable:!0},previousTargetPropertyPathValue:{value:null,writable:!0},targetPropertyPathCurrentIndex:{value:0,writable:!0},currentIndexListenee:{value:null,writable:!0},bindingOriginCurrentIndexListenee:{value:null,writable:!0},currentPropertyComponent:{value:null,writable:!0},bindingOrigin:{value:null,writable:!0},bindingPropertyPath:{value:null,writable:!0},bindingPropertyPathCurrentIndex:{value:0,writable:!0},bindingDescriptor:{value:null,writable:!0},applyBindingOriginDeferredValue:{value:function(){this.bindingOrigin.setProperty(this.bindingPropertyPath,this.deferredValue)}},applyTargetDeferredValue:{value:function(){this.target.setProperty(this.targetPropertyPath,this.deferredValue)}},applyDeferredValues:{value:function(){this.deferredValueTarget==="bound"?this.applyBindingOriginDeferredValue():this.deferredValueTarget==="target"&&this.applyTargetDeferredValue(),this.deferredValueTarget=""}},handleChange:{value:function(e){var t,n=this.bindingOrigin,r=this.bindingPropertyPath,i=n.getProperty(r),s=this.target,o=this.targetPropertyPath,u;s!==n?t=e.currentTarget===n:t=e.currentPropertyPath===r;if(t){if(n.setProperty.changeEvent)return;this.bindingDescriptor.converter&&(i=this.bindingDescriptor.converter.revert(i)),this.bindingOriginValueDeferred===!0||n._bindingsDisabled?(this.deferredValue=i,this.deferredValueTarget="target"):(this.bindingOriginChangeTriggered=!0,s.setProperty(o,i),this.bindingOriginChangeTriggered=!1)}else this.bindingOriginChangeTriggered||(u=s.getProperty(o),this.bindingDescriptor.boundValueMutator?u=this.bindingDescriptor.boundValueMutator(u):this.bindingDescriptor.converter&&(u=this.bindingDescriptor.converter.convert(u)),u!==i&&(this.bindingOriginValueDeferred===!0||n._bindingsDisabled?(this.deferredValue=u,this.deferredValueTarget="bound"):(n.setProperty.changeEvent=e,n.setProperty(r,u),n.setProperty.changeEvent=null)),this.previousTargetPropertyPathValue=u)}}});Object.defineProperty(Object.prototype,"propertyChangeBindingListener",{value:function(e,t,n,r,i,s,o){var u,a=PropertyChangeBindingListener.create();return a.useCapture=n,a.target=this,a.originalListener=t,a.originalListenerIsFunction=typeof t=="function",a.targetPropertyPath=u=e,a.previousTargetPropertyPathValue=this.getProperty(u),a.targetPropertyPathCurrentIndex=0,i&&(a.bindingOrigin=i,a.bindingPropertyPath=s,a.bindingDescriptor=o,a.bindingOriginValueDeferred=o.deferred?!0:!1),a},writable:!0});var BindingDescriptor=exports.BindingDescriptor=Montage.create(Montage,{boundObject:{enumerable:!1,value:null},boundObjectPropertyPath:{enumerable:!1,value:null},oneway:{enumerable:!1,value:null},deferred:{enumerable:!1,value:null},serializeSelf:{value:function(e){var t={};return e.addObjectReference(this.boundObject),t[this.oneway?"<-":"<->"]="@"+e.getObjectLabel(this.boundObject)+"."+this.boundObjectPropertyPath,t.deferred=this.deferred,t.converter=this.converter,t}}});Serializer.defineSerializationUnit("bindings",function(e){var t=e._bindingDescriptors;if(t){var n=!1,r={};for(var i in t){var s=t[i];if(!("serializable"in s)||s.serializable)n=!0,r[i]=s}if(n)return r}});var deserializeBindingToBindingDescriptor=exports.deserializeBindingToBindingDescriptor=function(e,t){var n;if(!("boundObject"in e)){var r=e["<-"]||e["<->"]||e["<<->"];"<<->"in e&&console.warn("WARNING: <<-> in bindings is deprectated, use <-> only, please update now.");if(!r)throw logger.error("Invalid binding syntax '"+JSON.stringify(e)+"'."),"Invalid binding syntax '"+JSON.stringify(e)+"'";if(r[0]!=="@")throw logger.error("Invalid binding syntax '"+r+"', should be in the form of '@label.path'."),"Invalid binding syntax '"+r+"'";n=r.indexOf("."),e.boundObject=t.getObjectByLabel(r.slice(1,n)),e.boundObjectPropertyPath=r.slice(n+1),"<-"in e&&(e.oneway=!0)}};Deserializer.defineDeserializationUnit("bindings",function(e,t,n){for(var r in t){var i=t[r],s;deserializeBindingToBindingDescriptor(i,n),Object.defineBinding(e,r,i)}});var __bindingCount=exports.Stats={count:0};Object.defineProperty(Object,"defineBinding",{value:function(e,t,n){var r=e._bindingDescriptors,i=typeof n.oneway=="undefined"?!1:n.oneway,s=n.boundObject,o=n.boundObjectPropertyPath,u,a,f;if(!s||!o)return;__bindingCount.count++,r||Montage.defineProperty(e,"_bindingDescriptors",{enumerable:!1,value:r=Object.create(Object.prototype)});if((n.__proto__||Object.getPrototypeOf(n))!==BindingDescriptor)if("__proto__"in n)n.__proto__=BindingDescriptor;else{var l=n;n=Object.create(BindingDescriptor);for(var c in l)n[c]=l[c]}a=r[t];if(!a){r[t]=n,f=s.propertyChangeBindingListener(o,null,!0,null,e,t,n);if(!f)return;return s=n.boundObject,o=f.targetPropertyPath,i=typeof n.oneway=="undefined"?!1:n.oneway,n.boundObjectPropertyPath=o,n.bindingListener=f,f.listener=f,s.addPropertyChangeListener(o,f,!1),i||e.addPropertyChangeListener(t,f,!1),u=s.getProperty(o),n.boundValueMutator?u=n.boundValueMutator(u):n.converter&&(u=n.converter.convert(u)),f.bindingOriginValueDeferred===!0||e._bindingsDisabled?(f.deferredValue=u,f.deferredValueTarget="bound"):e.setProperty(t,u),f}if(s!==a.boundObject||n.boundObjectPropertyPath!==a.boundObjectPropertyPath)throw"sourceObject property, "+t+", is already the source of a binding"}}),Montage.defineProperty(Object.prototype,"_bindingDescriptors",{enumerable:!1,value:null,writable:!0}),Object.defineProperty(Object.prototype,"_deserializeProperty_bindingDescriptors",{enumerable:!1,value:function(e,t){this._bindingDescriptorsToInstall=e}}),Object.defineProperty(Object,"deleteBinding",{value:function(e,t){var n=e._bindingDescriptors,r,i;t in n&&(__bindingCount.count--,r=n[t],i=typeof r.oneway=="undefined"?!0:r.oneway,r.boundObject.removePropertyChangeListener(r.boundObjectPropertyPath,r.bindingListener,!1),i||e.removePropertyChangeListener(t,r.bindingListener,!1),delete n[t])}}),Object.defineProperty(Object,"deleteBindings",{value:function(e){var t=e._bindingDescriptors;if(t)for(var n in t)t.hasOwnProperty(n)&&Object.deleteBinding(e,n)}}),Object.defineProperty(Object,"applyBindingsDeferredValues",{value:function(e,t){var n=e._bindingDescriptors,r;if(n)for(var i in n)n.hasOwnProperty(i)&&(r=n[i].bindingListener,r&&(!t||!r.bindingOriginValueDeferred)&&r.applyDeferredValues())}}),Montage.defineProperty(Object.prototype,"_bindingsDisabled",{enumerable:!1,value:null}),Object.defineProperty(Object,"disableBindings",{value:function(e){e._bindingsDisabled=!0}}),Object.defineProperty(Object,"enableBindings",{value:function(e){e._bindingsDisabled=!1,Object.applyBindingsDeferredValues(e,!0)}})