var Montage=require("montage").Montage,Component=require("ui/component").Component,FlowBezierSpline=require("ui/flow-bezier-spline").FlowBezierSpline,Flow=exports.Flow=Montage.create(Component,{didCreate:{value:function(){this._slideOffsets={}}},slotContent:{serializable:!0,value:null},_flowTranslateComposer:{value:null},_scrollingMode:{value:"linear"},scrollingMode:{serializable:!0,get:function(){return this._scrollingMode},set:function(e){switch(e){case"linear":case"drag":this._scrollingMode=e}}},_linearScrollingVector:{value:[-300,0]},linearScrollingVector:{seriazable:!0,get:function(){return this._linearScrollingVector},set:function(e){this._linearScrollingVector=e}},_repetition:{value:null},momentumDuration:{serializable:!0,value:650},_splinePaths:{value:null},splinePaths:{enumerable:!1,get:function(){return this._splinePaths||(this._splinePaths=[]),this._splinePaths},set:function(e){this._splinePaths=e}},appendPath:{value:function(e){var t=FlowBezierSpline.create(),n=e.knots,r=e.knots.length,i=[],s=[],o=[],u=[],a,f;t.parameters={};for(a in e.units)t.parameters[a]={data:[],units:e.units[a]};for(a=0;a<r;a++){i[a]=n[a].knotPosition,o[a]=n[a].previousHandlerPosition,s[a]=n[a].nextHandlerPosition,u[a]=n[a].previousDensity;for(f in e.units)t.parameters[f].data.push(n[a][f])}t.knots=i,t.previousHandlers=o,t.nextHandlers=s,t.densities=u,t._computeDensitySummation(),this.splinePaths.push(t),e.hasOwnProperty("headOffset")||(e.headOffset=0),e.hasOwnProperty("tailOffset")||(e.tailOffset=0),this._paths.push(e),this._updateLength()}},_paths:{value:null},paths:{get:function(){var e=this.splinePaths.length,t=[],n,r,i,s,o,u,a;for(o=0;o<e;o++){r=this.splinePaths[o].knots.length,n={knots:[],units:{}};for(u=0;u<r;u++)s={knotPosition:this.splinePaths[o].knots[u]},this.splinePaths[o].nextHandlers&&this.splinePaths[o].nextHandlers[u]&&(s.nextHandlerPosition=this.splinePaths[o].nextHandlers[u]),this.splinePaths[o].previousHandlers&&this.splinePaths[o].previousHandlers[u]&&(s.previousHandlerPosition=this.splinePaths[o].previousHandlers[u]),this.splinePaths[o].densities&&this.splinePaths[o].densities[u]&&(s.previousDensity=this.splinePaths[o].densities[u],s.nextDensity=this.splinePaths[o].densities[u]),n.knots.push(s);for(u in this.splinePaths[o].parameters){n.units[u]=this.splinePaths[o].parameters[u].units,i=this.splinePaths[o].parameters[u].data.length;for(a=0;a<i;a++)n.knots[a][u]=this.splinePaths[o].parameters[u].data[a]}this._paths[o].hasOwnProperty("headOffset")?n.headOffset=this._paths[o].headOffset:n.headOffset=0,this._paths[o].hasOwnProperty("tailOffset")?n.tailOffset=this._paths[o].tailOffset:n.tailOffset=0,t.push(n)}return t},set:function(e){var t=e.length,n;this._splinePaths=[],this._paths=[];for(n=0;n<t;n++)this.appendPath(e[n]);this.needsDraw=!0}},_cameraElement:{value:null},_cameraPosition:{value:[0,0,800]},_cameraTargetPoint:{value:[0,0,0]},_cameraFov:{value:50},_cameraRoll:{value:0},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){this._cameraPosition=e,this._isCameraUpdated=!0,this.needsDraw=!0}},cameraTargetPoint:{get:function(){return this._cameraTargetPoint},set:function(e){this._cameraTargetPoint=e,this._isCameraUpdated=!0,this.needsDraw=!0}},cameraFov:{get:function(){return this._cameraFov},set:function(e){this._cameraFov=e,this._isCameraUpdated=!0,this.needsDraw=!0}},cameraRoll:{get:function(){return this._cameraRoll},set:function(e){this._cameraRoll=e,this._isCameraUpdated=!0,this.needsDraw=!0}},_stride:{value:0},stride:{get:function(){return this._stride},set:function(e){this._stride=e}},_scrollingTransitionDurationMiliseconds:{value:500},_scrollingTransitionDuration:{value:"500ms"},scrollingTransitionDuration:{get:function(){return this._scrollingTransitionDuration},set:function(e){var t=e+"",n=t.length,r;n>=2&&t[n-1]==="s"?n>=3&&t[n-2]==="m"?r=t.substr(0,n-2)-0:r=t.substr(0,n-1)*1e3:(r=t-0,t+="ms"),!isNaN(r)&&this._scrollingTransitionDurationMiliseconds!==r&&(this._scrollingTransitionDurationMiliseconds=r,this._scrollingTransitionDuration=t)}},_scrollingTransitionTimingFunctionBezier:{value:[.25,.1,.25,1]},_scrollingTransitionTimingFunction:{value:"ease"},hasSelectedIndexScrolling:{value:!1},selectedIndexScrollingOffset:{value:0},_handleSelectedIndexesChange:{value:function(e){this.hasSelectedIndexScrolling&&e.plus&&this.startScrollingIndexToOffset(e.plus[0],this.selectedIndexScrollingOffset)}},_timingFunctions:{value:{ease:[.25,.1,.25,1],linear:[0,0,1,1],"ease-in":[.42,0,1,1],"ease-out":[0,0,.58,1],"ease-in-out":[.42,0,.58,1]}},scrollingTransitionTimingFunction:{get:function(){return this._scrollingTransitionTimingFunction},set:function(e){var t=e+"",n,r;if(this._timingFunctions.hasOwnProperty(t))this._scrollingTransitionTimingFunction=t,this._scrollingTransitionTimingFunctionBezier=this._timingFunctions[t];else if(t.substr(0,13)==="cubic-bezier("&&t.substr(t.length-1,1)===")"){n=t.substr(13,t.length-14).split(",");if(n.length===4){for(r=0;r<4;r++){n[r]-=0;if(isNaN(n[r]))return}n[0]<0?n[0]=0:n[0]>1&&(n[0]=1),n[2]<0?n[2]=0:n[2]>1&&(n[2]=1),this._scrollingTransitionTimingFunction="cubic-bezier("+n+")",this._scrollingTransitionTimingFunctionBezier=n}}}},_computeCssCubicBezierValue:{value:function(e,t){var n=.5,r=.25,i,s,o;for(o=0;o<20;o++)i=n*n,s=1-n,3*(s*s*n*t[0]+s*i*t[2])+i*n>e?n-=r:n+=r,r*=.5;return i=n*n,s=1-n,3*(s*s*n*t[1]+s*i*t[3])+i*n}},_isTransitioningScroll:{value:!1},stopScrolling:{value:function(){this._isTransitioningScroll=!1}},startScrollingIndexToOffset:{value:function(e,t){this._scrollingOrigin=this.scroll,this._scrollingDestination=e-t,this._scrollingDestination>this._length?this._scrollingDestination=this._length:this._scrollingDestination<0&&(this._scrollingDestination=0),this._isScrolling=!0,this._scrollingStartTime=Date.now(),this._isTransitioningScroll=!0,this.needsDraw=!0}},_isCameraUpdated:{value:!0},_width:{value:null},_height:{value:null},_repetitionComponents:{value:null},_boundingBoxSize:{value:[200,200,0]},boundingBoxSize:{serializable:!0,get:function(){return this._boundingBoxSize},set:function(e){this._boundingBoxSize=e,this.elementsBoundingSphereRadius=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])*.5}},_elementsBoundingSphereRadius:{value:283},elementsBoundingSphereRadius:{get:function(){return this._elementsBoundingSphereRadius},set:function(e){this._elementsBoundingSphereRadius!==e&&(this._elementsBoundingSphereRadius=e,this.needsDraw=!0)}},_halfPI:{value:Math.PI*.5},_doublePI:{value:Math.PI*2},_computeFrustumNormals:{value:function(){var e=this.cameraFov*.5*this._doublePI/360,t=Math.sin(e),n=Math.cos(e),r=t*this._width/this._height,i=this.cameraTargetPoint[0]-this.cameraPosition[0],s=this.cameraTargetPoint[1]-this.cameraPosition[1],o=this.cameraTargetPoint[2]-this.cameraPosition[2],u=this._halfPI-Math.atan2(o,i),a=i*Math.sin(u)+o*Math.cos(u),f,l,c,h,p,d,v=this._halfPI-Math.atan2(a,s),m,g=[[n,0,r],[-n,0,r],[0,n,t],[0,-n,t]],y,b=[],w;for(w=0;w<4;w++)y=g[w],f=y[0],l=y[1]*Math.cos(-v)-y[2]*Math.sin(-v),c=y[1]*Math.sin(-v)+y[2]*Math.cos(-v),h=f*Math.cos(-u)-c*Math.sin(-u),p=l,d=f*Math.sin(-u)+c*Math.cos(-u),m=1/Math.sqrt(h*h+p*p+d*d),b.push([h*m,p*m,d*m]);return b}},_segmentsIntersection:{value:function(e,t){var n=0,r=0,i,s,o=[];while(n<e.length&&r<t.length)e[n][0]>=t[r][1]?r++:e[n][1]<=t[r][0]?n++:(e[n][0]>=t[r][0]?i=e[n][0]:i=t[r][0],e[n][1]<=t[r][1]?s=e[n][1]:s=t[r][1],o.push([i,s]),e[n][1]<t[r][1]?n++:e[n][1]>t[r][1]?r++:(n++,r++));return o}},_computeVisibleRange:{value:function(e){var t=e._knots.length-1,n=this._cameraPosition[0],r=this._cameraPosition[1],i=this._cameraPosition[2],s=this._computeFrustumNormals(),o,u=[],a=[],f=[],l,c,h,p=this._elementsBoundingSphereRadius,d=e._knots,v=e._nextHandlers,m=e._previousHandlers,g=[],y=[];for(c=0;c<t;c++){o=s[0],u=e.directedPlaneBezierIntersection(n-o[0]*p,r-o[1]*p,i-o[2]*p,s[0],d[c],v[c],m[c+1],d[c+1],g);if(u.length){o=s[1],a=e.directedPlaneBezierIntersection(n-o[0]*p,r-o[1]*p,i-o[2]*p,s[1],d[c],v[c],m[c+1],d[c+1],g);if(a.length){l=this._segmentsIntersection(u,a);if(l.length){o=s[2],u=e.directedPlaneBezierIntersection(n-o[0]*p,r-o[1]*p,i-o[2]*p,s[2],d[c],v[c],m[c+1],d[c+1],g),l=this._segmentsIntersection(u,l);if(l.length){o=s[3],u=e.directedPlaneBezierIntersection(n-o[0]*p,r-o[1]*p,i-o[2]*p,s[3],d[c],v[c],m[c+1],d[c+1],g),l=this._segmentsIntersection(u,l);for(h=0;h<l.length;h++)f.push([c,l[h][0],l[h][1]])}}}}}var b=e._densities,w,E,S,x,T,N,C;for(c=0;c<f.length;c++)w=b[f[c][0]],E=b[f[c][0]+1],S=f[c][0]?e._densitySummation[f[c][0]-1]:0,x=f[c][1],T=f[c][2],N=(E-w)*x*x*.5+x*w+S,C=(E-w)*T*T*.5+T*w+S,y.push([N,C]);return y}},prepareForDraw:{value:function(){var e=this,t;this._repetitionComponents=this._repetition._childComponents,window.addEventListener("resize",function(){e._isCameraUpdated=!0,e.needsDraw=!0},!1)}},_updateIndexMap:{value:function(e,t){var n=this._repetition.indexMap,r=[],i,s,o=n&&!isNaN(n.length)?n.length:0;for(s=0;s<o;s++)typeof t[n[s]]=="number"?e[t[n[s]]]=null:r.push(s);for(s=i=0;i<r.length&&s<e.length;s++)e[s]!==null&&(this._repetition.mapIndexToIndex(r[i],e[s],!1),i++);for(i=o;s<e.length;s++)e[s]!==null&&(this._repetition.mapIndexToIndex(i,e[s],!1),i++);this._repetition.refreshIndexMap()}},willDraw:{value:function(){var e,t,n,r,i,s,o,u,a,f,l,c=[],h,p,d={},v=this._paths,m=v.length,g=this.splinePaths;this._isTransitioningScroll&&(h=(Date.now()-this._scrollingStartTime)/this._scrollingTransitionDurationMiliseconds,p=this._computeCssCubicBezierValue(h,this._scrollingTransitionTimingFunctionBezier),h<1?this.scroll=this._scrollingOrigin+(this._scrollingDestination-this._scrollingOrigin)*p:(this.scroll=this._scrollingDestination,this._isTransitioningScroll=!1)),this._width=this._element.clientWidth,this._height=this._element.clientHeight;if(g.length){a=this._numberOfIterations%m,f=(this._numberOfIterations-a)/m;for(i=0;i<m;i++){l=f+(i<a?1:0),e=this._computeVisibleRange(g[i]),g[i]._computeDensitySummation(),s=this._scroll-v[i].headOffset;for(n=0;n<e.length;n++){o=Math.ceil(e[n][0]+s),u=Math.ceil(e[n][1]+s),o<0&&(o=0),u>l&&(u=l);for(r=o;r<u;r++)t=r*m+i,typeof d[t]=="undefined"&&(d[t]=c.length,c.push(t))}}}this._updateIndexMap(c,d)}},draw:{value:function(){var e,t=this._repetitionComponents.length,n,r,i,s,o,u=this._paths.length,a,f,l,c,h,p,d=this._repetition._indexMap,v,m,g,y,b=1e-5,w=Date.now(),E=6,S=this.lastDrawTime?(w-this.lastDrawTime)*.018*this._elasticScrollingSpeed:0,x=1-S/E,T,N,C,k=this._minSlideOffsetIndex,L=this._maxSlideOffsetIndex;this.lastDrawTime=w;for(s=0;s<E;s++){for(e=this._draggedSlideIndex-1;e>=k;e--)T=this._getSlideOffset(e),N=this._getSlideOffset(e+1),C=(T-N)*x+N,C>0&&(C=0),this._updateSlideOffset(e,C);for(e=this._draggedSlideIndex+1;e<=L;e++)T=this._getSlideOffset(e),N=this._getSlideOffset(e-1),C=(T-N)*x+N,C<0&&(C=0),this._updateSlideOffset(e,C)}this._isTransitioningScroll&&(this.needsDraw=!0);if(this._isCameraUpdated){var A=Math.tan((90-this.cameraFov*.5)*this._doublePI/360)*this._height*.5,O=this.cameraTargetPoint[0]-this.cameraPosition[0],M=this.cameraTargetPoint[1]-this.cameraPosition[1],_=this.cameraTargetPoint[2]-this.cameraPosition[2],D=Math.atan2(-O,-_),P,H;P=O*-Math.sin(-D)+_*Math.cos(-D),H=Math.atan2(-M,-P),this._element.style.webkitPerspective=A+"px",this._cameraElement.style.webkitTransform="translate3d(0,0,"+A+"px)rotateX("+H+"rad)rotateY("+ -D+"rad)"+"translate3d("+ -this.cameraPosition[0]+"px,"+ -this.cameraPosition[1]+"px,"+ -this.cameraPosition[2]+"px)",this._isCameraUpdated=!1}if(this.splinePaths.length)for(e=0;e<t;e++)y=this.offset(d[e]),a=y.pathIndex,r=y.slideTime,m=this._splinePaths[a]._convertSplineTimeToBezierIndexTime(r),o=this._repetitionComponents[e].element.parentNode,m!==null?(f=this._splinePaths[a].getPositionAtIndexTime(m),g=this._splinePaths[a].getRotationAtIndexTime(m),i="-webkit-transform:translate3d("+(f[0]*1e5>>0)*1e-5+"px,"+(f[1]*1e5>>0)*1e-5+"px,"+(f[2]*1e5>>0)*1e-5+"px)"+(g[2]?"rotateZ("+(g[2]*1e5>>0)*1e-5+"rad)":"")+(g[1]?"rotateY("+(g[1]*1e5>>0)*1e-5+"rad)":"")+(g[0]?"rotateX("+(g[0]*1e5>>0)*1e-5+"rad)":"")+";"+this._splinePaths[a].getStyleAtIndexTime(m),o.setAttribute("style",i)):o.setAttribute("style","-webkit-transform:scale3d(0,0,0);opacity:0");else for(e=0;e<t;e++)o=this._repetitionComponents[e].element.parentNode,o.setAttribute("style","-webkit-transform:scale3d(0,0,0);opacity:0");this.needsDraw=!0}},_updateLength:{value:function(){if(this._paths){var e,t=this._paths.length,n,r,i=0,s,o,u;if(t>0){o=this._numberOfIterations%t,s=(this._numberOfIterations-o)/t;for(u=0;u<t;u++)e=this._paths[u],n=s+(u<o?1:0),r=n-e.tailOffset+e.headOffset-1,r>i&&(i=r);this.length=i}this.needsDraw=!0}}},_numberOfIterations:{value:0},numberOfIterations:{get:function(){return this._numberOfIterations},set:function(e){this._numberOfIterations!==e&&(this._numberOfIterations=e,this._updateLength())}},_objects:{value:null},objects:{get:function(){return this._objects},set:function(e){this._objects=e,this.needsDraw=!0}},contentController:{value:null},isSelectionEnabled:{value:null},selectedIndexes:{serializable:!1,value:null},activeIndexes:{serializable:!1,value:null},propertyChangeBindingListener:{value:function(e,t,n,r,i,s,o){return o.boundObjectPropertyPath.match(/objectAtCurrentIteration/)?this._repetition?(o.boundObject=this._repetition,this._repetition.propertyChangeBindingListener.apply(this._repetition,arguments)):null:Object.prototype.propertyChangeBindingListener.apply(this,arguments)}},_orphanedChildren:{value:null},deserializedFromTemplate:{value:function(){this._orphanedChildren=this.childComponents,this.childComponents=null}},templateDidLoad:{value:function(){var e,t=this.element.ownerDocument.createRange(),n,r=this;t.selectNodeContents(this.element),e=t.extractContents(),n=this._repetition.element.appendChild(document.createElement("div")),n.appendChild(e),n.setAttribute("data-montage-id","wrapper"),this._repetition.indexMapEnabled=!0,this._repetition.childComponents=this._orphanedChildren,this._repetition.willDraw=function(){r.needsDraw=!0},Object.defineBinding(this,"numberOfIterations",{boundObject:this._repetition,boundObjectPropertyPath:"_objects.count()",oneway:"true"})}},_length:{value:0},length:{get:function(){return this._length},set:function(e){e<0?this._length=0:this._length=e}},_scroll:{value:0},_range:{value:20},_hasElasticScrolling:{value:!1},hasElasticScrolling:{get:function(){return this._hasElasticScrolling},set:function(e){e?this._hasElasticScrolling=!0:this._hasElasticScrolling=!1}},_slideOffsets:{value:null},_slideOffsetsLength:{value:0},_maxSlideOffsetIndex:{value:-1},_minSlideOffsetIndex:{value:2e9},_updateSlideOffset:{value:function(e,t){var n=1e-4;e>=0&&(t<-n||t>n?(typeof this._slideOffsets[e]=="undefined"&&(this._slideOffsetsLength++,e<this._minSlideOffsetIndex&&(this._minSlideOffsetIndex=e),e>this._maxSlideOffsetIndex&&(this._maxSlideOffsetIndex=e)),this._slideOffsets[e]=t):this._removeSlideOffset(e))}},_incrementSlideOffset:{value:function(e,t){this._updateSlideOffset(e,this._getSlideOffset(e)+t)}},_removeSlideOffset:{value:function(e){if(typeof this._slideOffsets[e]!="undefined"){var t,n,r;delete this._slideOffsets[e],this._slideOffsetsLength--;if(e===this._minSlideOffsetIndex){t=Object.keys(this._slideOffsets),this._minSlideOffsetIndex=2e9;for(n=0;n<t.length;n++)r=t[n]|0,r<this._minSlideOffsetIndex&&(this._minSlideOffsetIndex=r)}if(e===this._maxSlideOffsetIndex){typeof t=="undefined"&&(t=Object.keys(this._slideOffsets)),this._maxSlideOffsetIndex=-1;for(n=0;n<t.length;n++)r=t[n]|0,r>this._maxSlideOffsetIndex&&(this._maxSlideOffsetIndex=r)}}}},_getSlideOffset:{value:function(e){return e<this._minSlideOffsetIndex?this._minSlideOffsetIndex>this._draggedSlideIndex?e=this._draggedSlideIndex:e=this._minSlideOffsetIndex:e>this._maxSlideOffsetIndex&&(this._maxSlideOffsetIndex<this._draggedSlideIndex?e=this._draggedSlideIndex:e=this._maxSlideOffsetIndex),typeof this._slideOffsets[e]!="undefined"?this._slideOffsets[e]:0}},scroll:{get:function(){return this._scroll},set:function(e){e<0&&(e=0),e>this.length&&(e=this.length);if(this._hasElasticScrolling&&this._draggedSlideIndex!==null){var t,n,r=this._draggedSlideIndex-this._range,i=this._draggedSlideIndex+this._range,s,o,u;r>this._minSlideOffsetIndex&&(r=this._minSlideOffsetIndex),i<this._maxSlideOffsetIndex&&(i=this._maxSlideOffsetIndex),s=e-this._scroll,r<0&&(r=0);for(t=r;t<=i;t++)t!==this._draggedSlideIndex?this._incrementSlideOffset(t,s):this._removeSlideOffset(t);this._scroll=e}else this._scroll=e;this.needsDraw=!0}},_isInputEnabled:{value:!0},isInputEnabled:{get:function(){return this._isInputEnabled},set:function(e){e?this._isInputEnabled=!0:this._isInputEnabled=!1}},_draggedSlideIndex:{value:0},draggedSlideIndex:{get:function(){return this._draggedSlideIndex},set:function(e){if(e!==this._draggedSlideIndex){if(e!==null){var t=this._getSlideOffset(e),n=this._minSlideOffsetIndex,r=this._maxSlideOffsetIndex,i;this._incrementSlideOffset(this._draggedSlideIndex,-t);for(i=n;i<=r;i++)i!==this._draggedSlideIndex&&this._incrementSlideOffset(i,-t);this._removeSlideOffset(e),this._scroll-=t,this._flowTranslateComposer._scroll=this._scroll}this._draggedSlideIndex=e,this.needsDraw=!0}}},_elasticScrollingSpeed:{value:1},lastDrawTime:{value:null},offset:{enumerable:!1,value:function(e){var t=this._paths.length,n=e%t,r=Math.floor(e/t)-this._scroll+this._paths[n].headOffset;return{pathIndex:n,slideTime:r+this._getSlideOffset(e)}}},serializeSelf:{value:function(e){e.setProperties();var t=this.originalContent;for(var n=0,r;r=t[n];n++)r.controller&&e.addObject(r.controller)}}})