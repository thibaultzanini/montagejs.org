var Montage=require("montage/core/core").Montage,Map=require("montage/core/shim/structures").Map,EffectHandler=require("effect/effect-handler").EffectHandler,Effect=require("effect/effect").Effect,GLSLProgram=require("effect/profiles/glsl/glsl-program").GLSLProgram;GLSLHandler=exports.GLSLHandler=Montage.create(Montage,{_GL:{enumerable:!1,value:null},GL:{enumerable:!1,get:function(){return this._GL},set:function(e){this._GL=e}},getSourceFromScript:{value:function(e){var t=null;if(e){t="";var n=e.firstChild;while(n)n.nodeType==3&&(t+=n.textContent),n=n.nextSibling}return t}},forEachGLSLPass:{value:function(e,t){var n=null,r=null;if(e.profiles&&e.profiles.GLSL){var i=e.profiles.GLSL,s=i.techniques;if(s){n=Object.keys(s);if(n.length){var o=n[0],u=s[o],a=Object.keys(u);a.forEach(function(e){t&&t(o,u[a])},this)}}}}},_EffectToGLSLProgram:{enumerable:!1,value:null},EffectToGLSLProgram:{enumerable:!1,get:function(){return this._EffectToGLSLProgram},set:function(e){this._EffectToGLSLProgram=e}},_createEffectToGLSLProgramIfNeeded:{enumerable:!1,value:function(){this.EffectToGLSLProgram||(this.EffectToGLSLProgram=new Map)}},GLSLProgramForEffect:{enumerable:!1,value:function(e,t){var n=this;if(typeof t=="undefined"||t===null)t=!0;this._createEffectToGLSLProgramIfNeeded();var r=this.EffectToGLSLProgram.get(e);return!r&&t&&this.forEachGLSLPass(e,function(t,i){var s=n.getSourceFromScript(i["x-shader/x-vertex"]),o=n.getSourceFromScript(i["x-shader/x-fragment"]),u=Montage.create(GLSLProgram);u.initWithShaders({"x-shader/x-vertex":s,"x-shader/x-fragment":o}),u.build(n.GL),n.EffectToGLSLProgram.set(e,u),r=u}),r}},unregisterEffect:{enumerable:!1,value:function(e){this.EffectToJShader&&this.EffectToJShader.delete(e)}},_setInputParameterValue:{value:function(e,t,n,r){var i=null,s=e.inputs[n],o=s.type,u=s.animatedValue;r||(r=n),i=this.GLSLProgramForEffect(e,!0),i.setValueForSymbol(r,u),i.use(this.GL)}},setInputParameterValue:{value:function(e,t,n){var r=this;this.forEachGLSLPass(e,function(n,i){var s=i.inputs;s&&(symbol=s[t].symbol),r._setInputParameterValue(e,n,t,symbol?symbol:t)})}},handleEvent:{value:function(e){var t=e.target,n=e.propertyPath.split(".");if(n.length===3){var r=n[1],i=t.inputs[r].value;this.setInputParameterValue(t,r,i)}else console.log("WARNING: unexepected path")}},unbindEffect:{value:function(e){this.unregisterEffect(e);var t=e.inputKeys;t.forEach(function(t){var n="change@inputs"+t+".animatedValue";e.removeEventListener(n,this,!1)},this)}},bindEffect:{value:function(e){var t=e.inputKeys;t.forEach(function(t){var n=e.inputs[t].value;typeof n!="undefined"&&n!==null&&this.setInputParameterValue(e,t,n)},this),t.forEach(function(t){var n="change@inputs."+t+".animatedValue";e.addEventListener(n,this,!1)},this)}}})