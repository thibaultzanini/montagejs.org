montageDefine("1245296","runtime/pass",{dependencies:["runtime/dependencies/gl-matrix","runtime/node","runtime/projection","runtime/camera","runtime/utilities"],factory:function(e,t,n){e("runtime/dependencies/gl-matrix");var r=e("runtime/node").Node,i=e("runtime/projection").Projection,s=e("runtime/camera").Camera,o=e("runtime/utilities").Utilities;t.LinkedListNode=Object.create(Object.prototype,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(e){this._content=e}},_previous:{value:null,writable:!0},previous:{get:function(){return this._previous},set:function(e){this._previous=e}},_next:{value:null,writable:!0},next:{get:function(){return this._next},set:function(e){this._next=e}},init:{value:function(e){this.content=e,this.previous=null,this.next=null}},removeFromList:{value:function(){this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous),this.next=null,this.previous=null}}}),t.LinkedList=Object.create(Object.prototype,{_tail:{value:null,writable:!0},tail:{get:function(){return this._tail},set:function(e){this._tail=e}},_head:{value:null,writable:!0},head:{get:function(){return this._head},set:function(e){this._head=e}},append:{value:function(e){this.head||(this.head=e),this.tail&&(e.previous=this.tail,this.tail.next=e),this.tail=e}},remove:{value:function(e){var t=e.content.id,n=!1,r=!1;this.tail===e&&(n=!0,this.tail=e.previous),this.head===e&&(r=!0,this.head=e.next)}}}),t.Pass=Object.create(Object.prototype,{_nodeIDToPrimitives:{value:null,writable:!0},_inputs:{value:null,writable:!0},inputs:{get:function(){return this._inputs},set:function(e){this._inputs=e}},_states:{value:null,writable:!0},states:{get:function(){return this._states},set:function(e){this._states=e}},_program:{value:null,writable:!0},program:{get:function(){return this._program},set:function(e){this._program=e}},_passes:{value:null,writable:!0},passes:{get:function(){return this._passes},set:function(e){this._passes=e}},_parentPass:{value:null,writable:!0},parentPass:{get:function(){return this._parentPass},set:function(e){this._parentPass=e}},_primitives:{value:null,writable:!0},primitives:{get:function(){return this._primitives},set:function(e){this._primitives=e}},_getPasses:{value:function(e){var t=Object.create(LinkedListNode);this.primitives&&(t.init(this),e.append(t));if(this.passes){var n=Object.keys(this.passes);n.forEach(function(t){var n=this.passes[t];n._getPasses(e)},this)}}},getPasses:{value:function(){var e=Object.create(LinkedList);return this._getPasses(e),e}},inputWillChange:{value:function(e,t){}},inputDidChange:{value:function(e){e==="scene"&&this.sceneDidChange()}},_addInputPropertyIfNeeded:{value:function(e){var t="_"+e,n=this;this.inputs.hasOwnProperty(e)===!1&&(Object.defineProperty(this.inputs,t,{writable:!0,value:null}),Object.defineProperty(this.inputs,e,{get:function(){return n.inputs[t]},set:function(r){n.inputWillChange.call(n,e,r),n.inputs[t]=r,n.inputDidChange.call(n,e)}}))}},_prepareInputsProperties:{value:function(){var e=["scene","viewPoint"];e.forEach(function(e){this._addInputPropertyIfNeeded(e)},this)}},addPass:{value:function(e){e.parentPass=this,this.passes[e.id]=e}},_updateSubPassesWithNodeIfNeeded:{value:function(e,t){var n=this._nodeIDToPrimitives[e.id];n||(this._nodeIDToPrimitives[e.id]=n={});if(t){var r=n[t.id];if(!r){n[t.id]=r={worldMatrix:mat4.create(),normalMatrix:mat3.create(),primitivesInfo:[]};var i=0;e.meshes&&(i=e.meshes.length);if(i===0)return;e.meshes.forEach(function(t){t.primitives&&t.primitives.forEach(function(n){if(n.material){var i=n.material.technique;if(i&&i.rootPass){var s=this.passes[i.rootPass.id];s||(this.addPass(i.rootPass),s=i.rootPass);var o={primitive:n,node:e,mesh:t,worldMatrix:r.worldMatrix,normalMatrix:r.normalMatrix};s.primitives.push(o),r.primitivesInfo.push(o)}}},this)},this)}}}},sceneDidChange:{value:function(){this._nodeIDToPrimitives={};var e=this,t=[];this.inputs.scene.rootNode.apply(function(n,r){return e._updateSubPassesWithNodeIfNeeded(n,r),n.cameras&&n.cameras.length&&(t=t.concat(n)),null},!0,null);if(t.length)this.inputs.viewPoint=t[0];else{var n=Object.create(i);n.initWithDescription({projection:"perspective",yfov:45,aspectRatio:1,znear:.1,zfar:100});var o=Object.create(s);o.init(),o.projection=n;var u=Object.create(r);u.init(),u.id="__default_camera",u.cameras.push(o),u&&this.inputs.scene.rootNode.children.push(u),this.inputs.viewPoint=u}}},init:{value:function(){return this.primitives=[],this.passes={},this.inputs={},this._prepareInputsProperties(),this}},isOpaque:{value:function(){return this.states?!this.states.BLEND:!0}},execute:{value:function(e){if(this.inputs.scene){var t=mat4.create(),n=this;mat4.inverse(this.inputs.viewPoint.transform,t);var r=t;e.renderer.projectionMatrix=this.inputs.viewPoint.cameras[0].projection.matrix,this.inputs.scene.rootNode.apply(function(e,t,r){var i=n._nodeIDToPrimitives[e.id],s=null,o=null,u=null;return t&&i&&(s=i[t.id],o=s.worldMatrix,u=s.normalMatrix),o||(o=mat4.create()),u||(u=mat3.create()),mat4.multiply(r,e.transform,o),i&&mat3.transpose(mat4.toInverseMat3(o),u),o},!0,r)}e.renderer.renderPass(this);var i=[];if(this.passes){var s=Object.keys(this.passes);s.forEach(function(t){var n=this.passes[t];n.isOpaque()?n.execute(e):i.push(n)},this),i.forEach(function(t){t.execute(e)},this)}}},hitTest:{value:function(e,t,n){if(this.inputs.scene&&this.inputs.viewPoint){var r=[],i=mat4.create(),s=this.inputs.viewPoint.transform,u=vec3.createFrom(s[12],s[13],s[14]),a=this;mat4.inverse(s,i);var f=vec3.create(),l=vec3.create(),c=this.inputs.viewPoint.cameras[0],h=[e[0],t[3]-e[1],c.projection.znear],p=[e[0],t[3]-e[1],c.projection.zfar],d=c.projection.matrix;vec3.unproject(h,i,d,t,f),vec3.unproject(p,i,d,t,l);var v=0,m=1,g=2,y=vec3.create(),b=vec3.create(),w=vec3.create(),E=mat4.identity();this.inputs.scene.rootNode.apply(function(e,t,s){var a=mat4.create(),c=mat4.create();mat4.multiply(s,e.transform,a),mat4.multiply(i,a,c);if(e.boundingBox){var h=mat4.create();mat4.inverse(a,h),mat4.multiplyVec3(h,f,b),mat4.multiplyVec3(h,l,w),vec3.subtract(w,b),vec3.normalize(w);var p=e.boundingBox;if(o.intersectsBBOX(p,[b,w])){var d=e.meshes;d.forEach(function(e){var t=e.boundingBox;t&&o.intersectsBBOX(t,[b,w])&&o.rayIntersectsMesh([b,w],e,c,r,n)},this),r.length>0&&r.sort(function(e,t){var n=vec3.create();vec3.subtract(e.intersection,u,n);var r=vec3.dot(n,n);vec3.subtract(t.intersection,u,n);var i=vec3.dot(n,n);return r-i})}}return a},!0,E)}return r}}})}})