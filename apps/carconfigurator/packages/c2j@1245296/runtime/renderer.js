require("runtime/dependencies/gl-matrix");var GLSLProgram=require("runtime/glsl-program").GLSLProgram,ResourceManager=require("helpers/resource-manager").ResourceManager;exports.Renderer=Object.create(Object,{shininess:{value:200,writable:!0},light:{value:[0,0,-1],writable:!0},specularColor:{value:[1,1,1],writable:!0},_bindedProgram:{value:null,writable:!0},bindedProgram:{get:function(){return this._bindedProgram},set:function(e){this._bindedProgram!==e&&this._webGLContext&&(this._bindedProgram=e,this._bindedProgram&&this._bindedProgram.use(this._webGLContext,!1))}},_debugProgram:{value:null,writable:!0},_lambertProgram:{value:null,writable:!0},_resourceManager:{value:null,writable:!0},_webGLContext:{value:null,writable:!0},_projectionMatrix:{value:null,writable:!0},projectionMatrix:{get:function(){return this._projectionMatrix},set:function(e){this._projectionMatrix=e}},debugProgram:{get:function(){if(!this._debugProgram){this._debugProgram=Object.create(GLSLProgram);var e="precision highp float;attribute vec3 vert;uniform mat4 u_mvMatrix; uniform mat4 u_projMatrix; void main(void) { gl_Position = u_projMatrix * u_mvMatrix * vec4(vert,1.0); }",t="precision highp float; void main(void) {  gl_FragColor = vec4(1.,0.,0.,1.); }";this._debugProgram.initWithShaders({"x-shader/x-vertex":e,"x-shader/x-fragment":t}),this._debugProgram.build(this.webGLContext)||console.log(this._debugProgram.errorLogs)}return this._debugProgram}},lambertProgram:{get:function(){if(!this._lambertProgram){this._lambertProgram=Object.create(GLSLProgram);var e="precision highp float;attribute vec3 vert;attribute vec3 normal; varying vec3 v_normal; uniform mat4 u_mvMatrix; uniform mat3 u_normalMatrix; uniform mat4 u_projMatrix; void main(void) { v_normal = normalize(u_normalMatrix * normal); gl_Position = u_projMatrix * u_mvMatrix * vec4(vert,1.0); }",t="precision highp float; uniform vec3 color; varying vec3 v_normal; void main(void) {  vec3 normal = normalize(v_normal);  float lambert = max(dot(normal,vec3(0.,0.,1.)), 0.); gl_FragColor = vec4(color.xyz *lambert, 1.); }";this._lambertProgram.initWithShaders({"x-shader/x-vertex":e,"x-shader/x-fragment":t}),this._lambertProgram.build(this.webGLContext)||console.log(this._lambertProgram.errorLogs)}return this._lambertProgram}},webGLContext:{get:function(){return this._webGLContext},set:function(e){this._webGLContext=e}},resourceManager:{get:function(){return this._resourceManager||(this._resourceManager=Object.create(ResourceManager),this._resourceManager.init()),this._resourceManager}},indicesDelegate:{value:{webGLContext:{value:null,writable:!0},handleError:function(e,t){console.log("ERROR:vertexAttributeBufferDelegate:"+e+" :"+t)},convert:function(e,t){t.indicesBuffer=new Uint16Array(e);var n=this.webGLContext,r=n.getParameter(n.ELEMENT_ARRAY_BUFFER_BINDING),i=n.createBuffer();return n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e,n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,r),i},resourceAvailable:function(e,t){}}},vertexAttributeBufferDelegate:{value:{webGLContext:{value:null,writable:!0},handleError:function(e,t){console.log("ERROR:vertexAttributeBufferDelegate:"+e+" :"+t)},convert:function(e,t){t.semantic==="VERTEX"&&(t.primitive.mesh.verticesBuffer=new Float32Array(e));var n=this.webGLContext,r=n.getParameter(n.ARRAY_BUFFER_BINDING),i=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,r),i},resourceAvailable:function(e,t){}}},textureDelegate:{value:{handleError:function(e,t){console.log("ERROR:textureDelegate:"+e+" :"+t)},convert:function(e,t){return e},resourceAvailable:function(e,t){}}},_lastMaxEnabledArray:{value:0,writable:!0},_blend:{value:!1},setState:{value:function(e,t,n){var r=this.webGLContext;switch(e){case r.BLEND:if(this._blend!==t||n)t?r.enable(r.BLEND):r.disable(r.BLEND),this._blend=t;break;default:}}},resetStates:{value:function(){var e=this.webGLContext;if(e&&this._lastMaxEnabledArray!==-1)for(var t=0;t<this._lastMaxEnabledArray;t++)e.disableVertexAttribArray(t);this._lastMaxEnabledArray=-1,this.bindedProgram=null,this.setState(this.BLEND,!0,!0)}},renderPrimitive:{value:function(e){var t=!1,n=e.worldMatrix,r=this.projectionMatrix,i=e.primitive,s=-1,o=this.webGLContext,u=t?this.debugProgram:this.bindedProgram,a={VERTEX:"vert",NORMAL:"normal",TEXCOORD:"texcoord"};u.getLocationForSymbol("u_projMatrix")&&u.setValueForSymbol("u_projMatrix",r),u.getLocationForSymbol("u_normalMatrix")&&u.setValueForSymbol("u_normalMatrix",e.normalMatrix),u.getLocationForSymbol("u_mvMatrix")&&u.setValueForSymbol("u_mvMatrix",n);var f=this.shininess;if(u.getLocationForSymbol("u_shininess")){f=i.material.inputs.shininess;if(typeof f=="undefined"||f===null)f=this.shininess;u.setValueForSymbol("u_shininess",f)}var l=this.light;if(u.getLocationForSymbol("u_light")){l=i.material.inputs.light;if(typeof l=="undefined"||l===null)l=this.light;u.setValueForSymbol("u_light",l)}var c=this.specularColor;if(u.getLocationForSymbol("u_specularColor")){c=i.material.inputs.specularColor;if(typeof c=="undefined"||c===null)c=this.specularColor;u.setValueForSymbol("u_specularColor",c)}var h=.3,p=h;if(u.getLocationForSymbol("u_reflectionIntensity")){p=i.material.inputs.reflectionIntensity;if(typeof p=="undefined"||p===null)p=h;u.setValueForSymbol("u_reflectionIntensity",p)}var d=1,v=d;if(u.getLocationForSymbol("u_transparency")){v=i.material.inputs.transparency;if(typeof v=="undefined"||v===null)v=d;u.setValueForSymbol("u_transparency",v)}if(u.getLocationForSymbol("u_diffuseColor")){var m=i.material.inputs.diffuseColor;u.setValueForSymbol("u_diffuseColor",m)}var g=0;if(u.getLocationForSymbol("u_diffuseTexture")){var y=i.material.inputs.diffuseTexture,b=this.resourceManager.getResource(y,this.textureDelegate,this.webGLContext);if(b){o.activeTexture(o.TEXTURE0+g),o.bindTexture(o.TEXTURE_2D,b);var w=u.getLocationForSymbol("u_diffuseTexture");typeof w!="undefined"&&(u.setValueForSymbol("u_diffuseTexture",g),g++)}}if(u.getLocationForSymbol("u_reflectionTexture")){var y=i.material.inputs.reflectionTexture,b=this.resourceManager.getResource(y,this.textureDelegate,this.webGLContext);if(b){o.activeTexture(o.TEXTURE0+g),o.bindTexture(o.TEXTURE_2D,b);var w=u.getLocationForSymbol("u_reflectionTexture");typeof w!="undefined"&&(u.setValueForSymbol("u_reflectionTexture",g),g++)}}u.commit(o);var E=!0;i.vertexAttributes.forEach(function(e){var n=e.accessor,r=a[e.semantic];if(r){this.vertexAttributeBufferDelegate.webGLContext=this.webGLContext;var f=this.resourceManager.getResource(n,this.vertexAttributeBufferDelegate,{semantic:e.semantic,primitive:i});f?o.bindBuffer(o.ARRAY_BUFFER,f):E=!1;if(E){var l=u.getLocationForSymbol(r);typeof l!="undefined"&&(l>s&&(s=l),this._lastMaxEnabledArray<l&&o.enableVertexAttribArray(l),o.vertexAttribPointer(l,n.elementsPerValue,o.FLOAT,!1,n.byteStride,0),t&&e.semantic=="VERTEX"&&o.drawArrays(o.POINTS,0,n.count))}}},this);if(!t){if(E){for(var S=s+1;S<this._lastMaxEnabledArray;S++)o.disableVertexAttribArray(S);i.step<1&&(i.step+=.05)}var x=null;this.indicesDelegate.webGLContext=this.webGLContext,x=this.resourceManager.getResource(i.indices,this.indicesDelegate,i),x&&E&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,x),o.drawElements(o.TRIANGLES,i.indices.length,o.UNSIGNED_SHORT,0))}return this._lastMaxEnabledArray=s,E}},programDelegate:{value:{handleError:function(e,t){console.log("ERROR:programDelegate:"+e+" :"+t)},convert:function(e,t){var n=t,r=Object.create(GLSLProgram);return r.initWithShaders(e),r.build(t)||(console.log(e),console.log(r.errorLogs)),r},resourceAvailable:function(e,t){}}},renderPass:{value:function(e){var t=e.primitives,n=t.length,r=this.webGLContext;if(e.program){var i=this.resourceManager.getResource(e.program,this.programDelegate,r);if(i){var s=!1;e.states&&e.states.BLEND&&(s=!0,r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)),this.setState(r.BLEND,s),this.bindedProgram=i;for(var o=0;o<n;o++)t[o].mesh.hidden||this.renderPrimitive(t[o])}}}}})