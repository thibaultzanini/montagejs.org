require("runtime/dependencies/gl-matrix");var Base=require("runtime/base").Base,Technique=require("runtime/technique").Technique,Pass=require("runtime/pass").Pass,GLSLProgram=require("runtime/glsl-program").GLSLProgram,ResourceDescription=require("runtime/resource-description").ResourceDescription,Uuid=require("montage/core/uuid").Uuid,Montage=require("montage").Montage,SimpleAnimation=Montage.create(Montage,{_path:{value:null,writable:!0},_type:{value:null,writable:!0},_startValue:{value:null,writable:!0},_savedStart:{value:null,writable:!0},_endValue:{value:null,writable:!0},_context:{value:null,writable:!0},_delegate:{value:null,writable:!0},_duration:{value:0,writable:!0},_startTime:{value:0,writable:!0},_intervalRequest:{value:0,writable:!0},_interpolatedValue:{value:null,writable:!0},init:{value:function(e,t,n,r,i,s,o){this._type=t,this._startValue=n,this._endValue=r,this._context=s,this._delegate=o,this._duration=i,this._path=e,this._startValue=vec3.create(),t==="vec3"?(this._savedStart=[n[0],n[1],n[2]],this._interpolatedValue=n):t==="vec4"?(this._savedStart=[n[0],n[1],n[2],n[3]],this._interpolatedValue=n):t==="float"&&(this._interpolatedValue=n)}},handleUpdate:{value:function(){var e=new Date,t=e.getTime()/1e3,n=(t-this._startTime)/this._duration;if(this._delegate){var r=this._interpolatedValue;this._type==="vec3"?(r[0]=(1-n)*this._savedStart[0]+n*this._endValue[0],r[1]=(1-n)*this._savedStart[1]+n*this._endValue[1],r[2]=(1-n)*this._savedStart[2]+n*this._endValue[2]):this._type==="vec4"?(r[0]=(1-n)*this._savedStart[0]+n*this._endValue[0],r[1]=(1-n)*this._savedStart[1]+n*this._endValue[1],r[2]=(1-n)*this._savedStart[2]+n*this._endValue[2],r[3]=(1-n)*this._savedStart[3]+n*this._endValue[3]):this._type==="float"&&(this._interpolatedValue=(1-n)*this._savedStart+n*this._endValue);if(n<1){var i=this;requestAnimationFrame(function(){i.handleUpdate.call(i)})}this._delegate&&this._delegate.handleAnimationValueUpdate&&this._delegate.handleAnimationValueUpdate(this,this._path,r)}}},stopAnimation:{value:function(){}},run:{value:function(){window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60,new Date)}}();var e=new Date,t=e.getTime()/1e3,n=this;this._startTime=t,this.handleUpdate()}}});exports.Material=Object.create(Base,{implicitAnimationsEnabled:{value:!1,writable:!0},animationDuration:{value:.7,writable:!1},animationDelegate:{value:null,writable:!0},_loader:{value:null,writable:!0},loader:{enumerable:!1,get:function(){return this._loader},set:function(e){this._loader=e}},_materialForID:{value:{},writable:!0},materialForID:{enumerable:!1,get:function(){return this._materialForID},set:function(e){this._materialForID=e}},_techniqueForID:{value:{},writable:!0},inputWillChange:{value:function(e,t){if(!this.technique)return;var n=null;if(this.technique)if(t===null||this.inputs[e]!==null&&typeof this.inputs[e]!="undefined"){if(t!==null)return;e==="reflectionTexture"&&(this.inputs.diffuseColor?this.inputs.transparency?n="lambert2":n="lambert0":this.inputs.diffuseTexture&&(this.inputs.transparency?n="lambert3":n="lambert1"))}else e==="diffuseColor"?(this.inputs.diffuseTexture&&delete this.inputs.diffuseTexture,this.inputs.transparency?n="lambert2":n="lambert0"):e==="diffuseTexture"?(this.inputs.diffuseColor&&delete this.inputs.diffuseColor,this.inputs.transparency?n="lambert3":n="lambert1"):e==="transparency"?this.inputs.diffuseColor?n="lambert2":n="lambert3":e==="reflectionTexture"&&(this.inputs.diffuseColor?this.inputs.transparency?n="lambert6":n="lambert4":this.inputs.transparency?n="lambert7":n="lambert5");if(n){var r=this._techniqueForID[n];if(r===this.technique)return;var i=this.technique,s=[];if(i){var o=i.rootPass,u=[];o.primitives.forEach(function(e){e.primitive.material===this?s.push(e):u.push(e)},this),i.rootPass.primitives=u}if(!r){r=Object.create(Technique).init(),r.rootPass=Object.create(Pass).init(),r.rootPass.id=n,i&&i.rootPass.parentPass.addPass(r.rootPass);var a=this.loader.resolvePathIfNeeded(n+"Vs.glsl"),f=this.loader.resolvePathIfNeeded(n+"Fs.glsl"),l=Object.create(ResourceDescription).init("__shadervs_"+n,{path:a,type:"shader"});l.type="shader";var c=Object.create(ResourceDescription).init("__shaderfs_"+n,{path:f,type:"shader"});c.type="shader";var h={};h[GLSLProgram.VERTEX_SHADER]=l,h[GLSLProgram.FRAGMENT_SHADER]=c,r.rootPass.program=Object.create(ResourceDescription).init("__program"+n,h),r.rootPass.program.type="program",n==="lambert2"||n==="lambert3"||n==="lambert6"||n==="lambert7"?r.rootPass.states={BLEND:!0}:r.rootPass.states={BLEND:!1},this._techniqueForID[n]=r}s.forEach(function(e){r.rootPass.primitives.push(e)},this),this.technique=r}}},inputDidChange:{value:function(e){}},handleAnimationValueUpdate:{value:function(e,t,n){this.inputs["_"+t]=n,this.animationDelegate&&this.animationDelegate.handleAnimationValueUpdate()}},_addInputPropertyIfNeeded:{value:function(e){var t="_"+e,n=this;this.inputs.hasOwnProperty(e)===!1&&(Object.defineProperty(this.inputs,t,{writable:!0,value:null}),Object.defineProperty(this.inputs,e,{get:function(){return n.inputs[t]},set:function(r){var i=n.inputs[e];n.inputWillChange.call(n,e,r);if(e==="diffuseTexture"||e==="reflectionTexture"){if(typeof r=="string"){var s=r,o=Object.create(ResourceDescription).init(s,{path:s});o.type="image",r=o}else if(r!==null){var u=r,a=u.__uuid;if(!a){var f=u.src;f?a=f.split("/").join("_"):a=Uuid.generate(),u.__uuid=a}var o=Object.create(ResourceDescription).init(a,{image:u});o.type="image",r=o}}else if(n.implicitAnimationsEnabled&&e==="diffuseColor"&&i!==null&&i!=="undefined"){var l=Montage.create(SimpleAnimation);l.init(e,"vec3",i,r,n.animationDuration,this,n),l.run()}else if(n.implicitAnimationsEnabled&&e==="transparency"&&i!==null&&i!=="undefined"){var l=Montage.create(SimpleAnimation);l.init(e,"float",i,r,n.animationDuration,this,n),l.run()}else n.inputs[t]=r;n.inputDidChange.call(n,e)}}))}},_prepareInputsProperties:{value:function(){var e=["diffuseColor","diffuseTexture","transparency","reflectionTexture","reflectionIntensity","shininess","specularColor"];e.forEach(function(e){this._addInputPropertyIfNeeded(e)},this)}},_technique:{value:null,writable:!0},technique:{enumerable:!1,get:function(){return this._technique},set:function(e){this._technique=e}},_material:{value:null,writable:!0},material:{enumerable:!1,get:function(){return this._material},set:function(e){this._material=e}},_inputs:{value:null,writable:!0},inputs:{enumerable:!1,get:function(){return this._inputs},set:function(e){var t=Object.keys(e);t.forEach(function(t){this._inputs[t]=e[t]},this)}},init:{value:function(e){return this.id=e,this.__Base_init(),this._inputs={},this._prepareInputsProperties(),this.materialForID[e]=this,this}}})