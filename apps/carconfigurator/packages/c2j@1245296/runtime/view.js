require("runtime/dependencies/gl-matrix");var Engine=require("runtime/engine").Engine,Utilities=require("runtime/utilities").Utilities;exports.View=Object.create(Object.prototype,{_sceneBBox:{value:null,writable:!0},sceneBBox:{get:function(){return this._sceneBBox},set:function(e){this._sceneBBox=e}},_canvas:{value:null,writable:!0},canvas:{get:function(){return this._canvas},set:function(e){this._canvas=e}},_delegate:{value:null,writable:!0},delegate:{get:function(){return this._delegate},set:function(e){this._delegate=e}},_engine:{value:null,writable:!0},engine:{get:function(){return this._engine},set:function(e){this._engine=e}},scene:{get:function(){return this.engine&&this.engine.rootPass?this.engine.rootPass.inputs.scene:null},set:function(e){if(this.engine&&this.engine.rootPass){var t=mat4.identity(),n=e.rootNode,r=e.rootNode.boundingBox;e.rootNode.apply(function(e,t,n){var i=mat4.create();mat4.multiply(n,e.transform,i);if(e.boundingBox){var s=Utilities.transformBBox(e.boundingBox,n);r?r=Utilities.mergeBBox(s,r):r=s}return i},!0,t),this.sceneBBox=r,this.engine.rootPass.inputs.scene=e}}},init:{value:function(e){window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60,new Date)}}(),this.canvas=document.getElementById(e);var t=this.canvas.getContext("experimental-webgl",{antialias:!0})||this.canvas.getContext("webgl",{antialias:!0}),n=null;this.engine=Object.create(Engine),this.engine.init(t,n),this.userControlMatrix=mat4.identity();var r=this;requestAnimationFrame(function(){r.draw.call(r)},this.canvas);var i=function(e){r._mouseIsDown=!0,r._mousePosition=[e.pageX,e.pageY],e.preventDefault();var t=r.hitTest(r._mousePosition);t&&t.length&&(t[0].mesh.primitives[0].material.inputs.diffuseColor=[1,0,0])},s=function(e){r._mouseIsDown=!1,e.preventDefault()},o=function(e){if(r._mouseIsDown){var t=[e.pageX,e.pageY],n=t[0]-r._mousePosition[0],i=t[1]-r._mousePosition[1],s=mat4.rotate(mat4.identity(),n*.005,[0,1,0]);mat4.rotate(s,i*.005,[1,0,0]),mat4.multiply(s,r.userControlMatrix,r.userControlMatrix),r._mousePosition=t}e.preventDefault()};this.canvas.addEventListener("touchstart",i,!1),document.addEventListener("touchend",s,!1),document.addEventListener("touchmove",o,!1),this.canvas.addEventListener("mousedown",i,!1),document.addEventListener("mouseup",s,!1),document.addEventListener("mousemove",o,!1)}},hitTest:{value:function(e,t){if(this.engine&&this.engine.rootPass&&this.canvas){var n=[0,0,parseInt(this.canvas.getAttribute("width")),parseInt(this.canvas.getAttribute("height"))];return this.engine.rootPass.hitTest(e,n)}return null}},getWebGLContext:{value:function(){return this.engine?this.engine.renderer.webGLContext:null}},_mouseIsDown:{writable:!0,value:!1},_mousePosition:{writable:!0,value:null},userControlMatrix:{writable:!0,value:null},draw:{value:function(){var e=this.getWebGLContext();e&&e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT),this.delegate&&this.delegate.willDraw(this);if(this.scene){var t=this.engine.renderer;if(e){var n=parseInt(this.canvas.getAttribute("width")),r=parseInt(this.canvas.getAttribute("height"));e.viewport(0,0,n,r),e.depthFunc(e.LESS),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE);var i=this.engine.rootPass.inputs.viewPoint;if(i){i.cameras[0].projection.aspectRatio=n/r;if(i.id==="__default_camera"){var s=this.scene.rootNode;s.transform=mat4.identity();var o=this.sceneBBox,u=[o[1][0]-o[0][0],o[1][1]-o[0][1],o[1][2]-o[0][2]],a=u[0]>u[1]?u[0]:u[1];a=u[2]>a?u[2]:a,a=1/a;var f=mat4.scale(mat4.identity(),[a,a,a]),l=mat4.translate(f,[-u[0]/2-o[0][0],-u[1]/2-o[0][1],-u[2]/2-o[0][2]]),c=mat4.translate(mat4.identity(),[0,0,-1.3]),h=mat4.create();mat4.multiply(this.userControlMatrix,l,h),mat4.multiply(c,h,s.transform)}}this.engine.render(),e.flush();var p=e.getError();p!=e.NO_ERROR&&console.log("gl error"+e.getError())}}var d=this;requestAnimationFrame(function(){d.draw.call(d)},this.canvas),this.delegate&&this.delegate.didDraw(this)}}})