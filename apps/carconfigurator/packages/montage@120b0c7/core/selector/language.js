var Montage=require("montage").Montage,AbstractLanguage=require("./abstract-language").AbstractLanguage,Semantics=require("./semantics").Semantics,PropertyLanguage=require("./property-language").PropertyLanguage,Language=exports.Language=AbstractLanguage.create(AbstractLanguage,{semantics:{value:Semantics},grammar:{value:function(){var e,t;this.parsePrimary(function(e){return t(e)}),this.parseProperties(),this.parseLeftToRight(["startsWith","endsWith"]),this.parseLeftToRight(["pow"]),this.parseLeftToRight(["mul","div","mod"]),this.parseLeftToRight(["add","sub"]),this.parseBinary(["lessThan","greaterThan","lessThanOrEquals","greaterThanOrEquals"]),this.parseBinary(["equals","notEquals"]),this.parseLeftToRight(["xor"]),this.parseLeftToRight(["and"]),this.parseLeftToRight(["or"]),this.parseConditional(),e=this.precedence(),this.parseArray(),this.parseRightToLeft(["has","contains","every","some","one","only","filter","map","it"]),this.parseSorted(e),this.parseSlice(e),this.parseRightToLeft(["sum","count","average","unique","flatten"]),t=this.precedence(),this.parseOperator()}},aliases:{value:{lt:"lessThan",gt:"greaterThan",le:"lessThanOrEquals",ge:"greaterThanOrEquals",eq:"equals",ne:"notEquals"}},constants:{value:{"true":!0,"false":!1}},selectorExtras:{value:{property:{value:function(e){try{var t=this,n=PropertyLanguage.parse(e);return PropertyLanguage.reemit(n,function(e){t=t.emit(e)}),t}catch(r){throw r}}},matches:{value:function(e){var t=this.language.Selector,n=this.it["true"],r=n.language.tokens;for(var i in e){var s=e[i];i=i.split("_");var o=i.shift();n.emit(r.and),t.property(o).tokens.forEach(function(e){n.emit(e)}),i.length?i.forEach(function(e){n.emit(r[e])}):n.emit(r.equals),n.emit({type:"literal",value:s})}return n}}}},parseIdentifier:{value:function(e){var t=this;return t.requireTokens(["literal"]),function(t){if(t.type==="literal"&&typeof t.value=="string")return e(t.value);throw new SyntaxError("Expected identifier, got: "+JSON.stringify(t.type))}}},parseUrPrimary:{value:function(e,t,n,r){var i=this;return function(s){return s.type==="begin"?t(function(t){return i.expect("end",function(){return e(t,n)})}):s.type==="value"?e(i.tokens.value,n):s.type==="parameter"?i.parseIdentifier(function(t){var r=t.split(".").reduce(function(e,t){return{type:"get",args:[e,{type:"literal",value:t}]}},{type:"parameters"});return e(r,n)}):s.type==="literal"?e(s,n):i.constants[s.type]?e(i.constantSyntax[s.type],n):r(e(i.tokens.value,!1))(s)}}},parsePrimary:{value:function(e){var t=this;return t.requireTokens(["begin","end","value","literal","parameter","not"]),t.precedence(function(){return function(n){return t.optional("not",function(r,i){return t.parseUrPrimary(function(e,r){return r&&(e=t.makeSyntax("not",[e])),n(e)},e,r,i)})}})}},parseProperties:{value:function(){var e=this;e.requireTokens(["get"]);var t=e.precedence(function(n){return function(r,i){return function(s){return s.type==="get"?e.expect("literal",function(n){return i=e.makeSyntax("get",[i||e.tokens.value,n]),t(r,i)}):i?r(i)(s):n(r)(s)}}});return t}},parseConditional:{value:function(){var e=this;return e.requireTokens(["if","then","else"]),e.precedence(function(t){return function(n){return function(r){return r.type==="if"?t(function(r){return e.expect("then",function(){return t(function(i){return e.expect("else",function(){return t(function(t){return n(e.makeSyntax("if",[r,i,t]))})})})})}):t(n)(r)}}})}},parseArray:{value:function(){var e=this;e.requireTokens(["array","comma"]);var t=e.precedence(function(t){return function(n){return e.optional("array",function(r){return r?e.parseArrayTerms(function(e){return n({type:"array",terms:e})},[],t):t(n)})}});return t}},parseArrayTerms:{value:function(e,t,n){var r=this;return r.optional("end",function(i,s){return i?e(t):n(function(i){var s=t.concat([i]);return r.optional("comma",function(t){return t?r.parseArrayTerms(e,s,n):r.expect("end",function(){return e(s)})})})})}},parseSorted:{value:function(e){var t=this;return t.requireTokens(["sorted","by","descending"]),t.precedence(function(n){return function(r){return n(function(n){return function(i){if(i.type==="sorted"){var s=function(e){return t.optional("descending",function(i){return r(t.makeSyntax("sorted",[n,e||{type:"value"},{type:"literal",value:i}]))})};return t.optional("by",function(t){return t?e(s):s()})}return r(n)(i)}})}})}},parseSlice:{value:function(e){var t=this;return t.requireTokens(["slice","from","comma"]),t.precedence(function(n){return function(r){return n(function(n){return function(i){return i.type==="slice"?t.optional("from",function(i){return e(function(s){return t.expect("comma",function(o,u){return e(function(e){return r(t.makeSyntax(i?"sliceFrom":"slice",[n,s,e]))})})})}):r(n)(i)}})}})}}})