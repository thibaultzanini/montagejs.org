var Montage=require("montage").Montage,Composer=require("ui/composer/composer").Composer,KEYPRESS_EVENT_TYPE="keyPress",LONGKEYPRESS_EVENT_TYPE="longKeyPress",KEYRELEASE_EVENT_TYPE="keyRelease",KeyComposer=exports.KeyComposer=Montage.create(Composer,{_isLoaded:{value:!1},_shouldDispatchEvent:{value:!1},shouldDispatchLongPress:{value:!1},_longPressTimeout:{value:null},_keyRegistered:{value:!1},_keys:{value:null},keys:{get:function(){return this._keys},set:function(e){this._keyRegistered?(KeyManagerProxy.defaultKeyManager.unregisterKey(this),this._keys=e,KeyManagerProxy.defaultKeyManager.registerKey(this)):this._keys=e}},_identifier:{value:null},identifier:{get:function(){return this._identifier},set:function(e){this._identifier=e}},createKey:{value:function(e,t,n){var r=this;return this===KeyComposer&&(r=KeyComposer.create()),n||(e.identifier?n=e.identifier+t.toLowerCase().replace(/[ +]/g).toCapitalized():n=t.toLowerCase().replace(/[ +]/g)),r.keys=t,r.identifier=n,e.addComposer(r),r}},createGlobalKey:{value:function(e,t,n){var r=this;return this===KeyComposer&&(r=KeyComposer.create()),r.keys=t,r.identifier=n,e.addComposerForElement(r,window),r}},load:{value:function(){this._isLoaded=!0,this._shouldDispatchEvent&&!this._keyRegistered&&(KeyManagerProxy.defaultKeyManager.registerKey(this),this._keyRegistered=!0)}},unload:{value:function(){this._isLoaded=!1,KeyManagerProxy.defaultKeyManager.unregisterKey(this),this._keyRegistered=!1}},addEventListener:{value:function(e,t,n){var r=this.component;Composer.addEventListener.call(this,e,t,n);if(e==KEYPRESS_EVENT_TYPE||e==LONGKEYPRESS_EVENT_TYPE||e==KEYRELEASE_EVENT_TYPE)this._shouldDispatchEvent=!0,e==LONGKEYPRESS_EVENT_TYPE&&(this._shouldDispatchLongPress=!0),this._isLoaded?this._keyRegistered||(KeyManagerProxy.defaultKeyManager.registerKey(this),this._keyRegistered=!0):r&&typeof r.addComposer!="function"&&(this.element||(this.element=window),this.load())}},didCreate:{value:function(){}},deserializedFromTemplate:{value:function(){var e=this.component;this.identifier===null&&(this.identifier=Montage.getInfoForObject(this).label),e&&(typeof e.addComposer=="function"?e.addComposer(this):this._isLoaded||(this.element||(this.element=window),this.load()))}}}),_keyManagerProxy=null,KeyManagerProxy=Montage.create(Montage,{_defaultKeyManager:{value:null},_loadingDefaultKeyManager:{value:!1},_keysToRegister:{value:[]},didCreate:{value:function(){}},registerKey:{value:function(e){var t=this;this._defaultKeyManager?this._defaultKeyManager.registerKey(e):(this._keysToRegister.push(e),this._loadingDefaultKeyManager||(this._loadingDefaultKeyManager=!0,require.async("core/event/key-manager").then(function(e){var n=t._defaultKeyManager=e.defaultKeyManager;t._keysToRegister.forEach(function(e){n.registerKey(e)}),t._keysToRegister.length=0}).done()))}},unregisterKey:{value:function(e){this._defaultKeyManager&&this._defaultKeyManager.unregisterKey(e)}},defaultKeyManager:{get:function(){return _keyManagerProxy||(_keyManagerProxy=KeyManagerProxy.create()),this._defaultKeyManager?this._defaultKeyManager:_keyManagerProxy}}})