var Montage=require("montage").Montage,Component=require("ui/component").Component,dom=require("ui/dom"),Point=require("core/geometry/point").Point;exports.RichTextResizer=Montage.create(Component,{_isActive:{enumerable:!1,value:!1},_editor:{enumerable:!1,value:null},target:{enumerable:!1,value:null},_draggedElement:{enumerable:!1,value:null},_needsReset:{enumerable:!1,value:!1},initWithEditor:{value:function(e){this._editor=e}},editorMouseDown:{value:function(e){var t=e.target;if(this._isActive&&t===this.element)return e.preventDefault(),e.stopPropagation(),!0}},editorTouchStart:{value:function(e){this.editorMouseDown(e)}},editorMouseUp:{value:function(e){var t=e.target,n=this.target;if(this._observedPointer)return!0;if(t===this.element&&this._editor.activeOverlay==this)this._editor.hideOverlay(),e.target=this.target,e.preventDefault(),e.stopPropagation();else{if(t.tagName==="IMG")return t!==n&&(n&&(n.classList.remove("montage-Resizer-element"),n.classList.length==0&&n.removeAttribute("class")),this.target=t,this._needsReset=!0,this._isActive?this.needsDraw=!0:(this._ignoreNextSelectionchanged=!0,this._editor.showOverlay(this))),e.preventDefault(),e.stopPropagation(),!0;this._editor.activeOverlay==this&&this._editor.hideOverlay()}return!1}},editorTouchEnd:{value:function(e){this.editorMouseUp(e)}},editorSelectionDidChange:{value:function(e){return this._ignoreNextSelectionchanged||this._finalizeDrag?this._ignoreNextSelectionchanged=!1:(this._editor.activeOverlay==this&&this._editor.hideOverlay(),this.target=null),!1}},draw:{enumerable:!1,value:function(){var e=this.element,t=this.target,n=this._editor.innerElement,r;if(this._needsReset){var i,s,o=function(e){s=e.offsetTop,i=e.offsetLeft;while((e=e.offsetParent)&&e!=n)s+=e.offsetTop,i+=e.offsetLeft};o(t),r=e.style,r.width=t.offsetWidth+"px",r.height=t.offsetHeight+"px",r.top=s+"px",r.left=i+"px",this._editor.innerElement.classList.remove("montage-Editor--resizing"),t.classList.add("montage-Resizer-element"),this.image.src=t.src,this.image.title=t.title,this.image.alt=t.alt,this._selectElement(t),this._needsReset=!1}if(this._draggedElement){var u=Point.create().init(0,0),a=dom.convertPointFromNodeToPage(e,u),f=this._cursorPosition,l=this._draggedElement.getAttribute("data-montage-id").substring("montage-resizer-handle-".length),c=this._resizerFrameInfo,h=c.ratio,p=parseFloat(e.style.height,10),d=parseFloat(e.style.width,10),v=parseFloat(e.style.top,10),m=parseFloat(e.style.left,10),g=15;this._editor.innerElement.classList.add("montage-Editor--resizing"),l=="n"?(p+=a.y-f.y,v=c.top-(p-c.height)):l=="ne"?(p+=a.y-f.y,d=Math.round(p*h),f.x>a.x+d&&(d=f.x-a.x,p=Math.round(d/h)),v=c.top-(p-c.height)):l=="e"?d=f.x-a.x:l=="se"?(p=f.y-a.y,d=Math.round(p*h),f.x>a.x+d&&(d=f.x-a.x,p=Math.round(d/h))):l=="s"?p=f.y-a.y:l=="sw"?(p=f.y-a.y,d=Math.round(p*h),f.x<=a.x-d+e.clientWidth&&(d=e.clientWidth+a.x-f.x,p=Math.round(d/h)),m=c.left-(d-c.width)):l=="w"?(d+=a.x-f.x,m=c.left-(d-c.width)):l=="nw"&&(p+=a.y-f.y,d=Math.round(p*h),f.x<=a.x-d+e.clientWidth&&(d=e.clientWidth+a.x-f.x,p=Math.round(d/h)),v=c.top-(p-c.height),m=c.left-(d-c.width)),p>g&&d>g&&(e.style.height=p+"px",e.style.width=d+"px",e.style.top=v+"px",e.style.left=m+"px")}if(this._finalizeDrag){d=e.clientWidth,p=e.clientHeight,this._editor.innerElement.classList.remove("montage-Editor--resizing"),t.classList.remove("montage-Resizer-element"),t.classList.length==0&&t.removeAttribute("class"),this._selectElement(t);var y=document.createElement("div"),b,w;y.appendChild(t.cloneNode(!0)),b=y.firstChild,b.width=d,b.height=p,b.style.removeProperty("width"),b.style.removeProperty("height"),w=b.id,b.id="montage-editor-resized-image",this._editor.execCommand("inserthtml",!1,y.innerHTML,"Resizing Image"),t=document.getElementById(b.id),t&&(w!==undefined&&w!==""?t.id=w:t.removeAttribute("id"),this.target=t,this._needsReset=!0,this.needsDraw=!0),this._finalizeDrag=!1}}},didBecomeActive:{value:function(){this._isActive=!0,this.element.addEventListener(window.Touch?"touchstart":"mousedown",this,!1),window.addEventListener("resize",this,!1)}},didBecomeInactive:{value:function(){var e=this.target;this._isActive=!1,this.element.removeEventListener(window.Touch?"touchstart":"mousedown",this,!1),window.removeEventListener("resize",this,!1),this._draggedElement&&(window.Touch?(document.removeEventListener("touchmove",this),document.removeEventListener("touchend",this)):(document.removeEventListener("mousemove",this),document.removeEventListener("mouseup",this)),this._releaseInterest()),e&&(e.classList.remove("montage-Resizer-element"),e.classList.length==0&&e.removeAttribute("class"),this._editor.markDirty()),this.target=null,this._needsReset=!1,this._draggedElement=null,this._finalizeDrag=!1}},handleResize:{enumerable:!1,value:function(){this._needsReset=!0,this.needsDraw=!0}},handleMousedown:{value:function(e){var t=e.target,n=this.element;t.classList.contains("montage-Resizer-handle")&&(window.Touch?(this._observePointer(t.id),document.addEventListener("touchmove",this),document.addEventListener("touchend",this)):(this._observePointer("mouse"),document.addEventListener("mousemove",this),document.addEventListener("mouseup",this)),this._resizerFrameInfo={width:n.clientWidth,height:n.clientHeight,left:parseInt(n.style.left,10),top:parseInt(n.style.top,10),ratio:n.clientWidth/n.clientHeight},this._cursorPosition={x:e.pageX,y:e.pageY},this._draggedElement=t,e.preventDefault(),e.stopPropagation())}},handleTouchstart:{value:function(e){this.handleMousedown(e)}},handleMousemove:{value:function(e){this._cursorPosition={x:e.pageX,y:e.pageY},this.needsDraw=!0,e.preventDefault(),e.stopPropagation()}},handleTouchmove:{value:function(e){this.handleMousemove(e)}},handleMouseup:{value:function(e){this._draggedElement&&(window.Touch?(document.removeEventListener("touchmove",this),document.removeEventListener("touchend",this)):(document.removeEventListener("mousemove",this),document.removeEventListener("mouseup",this)),this._draggedElement=null,this._finalizeDrag=!0,this.needsDraw=!0,this._releaseInterest(),e.preventDefault(),e.stopPropagation())}},handleTouchend:{value:function(e){this.handleMouseup(e)}},surrenderPointer:{value:function(e,t){return!1}},_observePointer:{value:function(e){this.eventManager.claimPointer(e,this),this._observedPointer=e}},_releaseInterest:{value:function(){this.eventManager.forfeitPointer(this._observedPointer,this),this._observedPointer=null}},_selectElement:{value:function(e){var t,n;this._ignoreNextSelectionchanged=!0,this._editor.selectElement(e)}}})