var Montage=require("montage").Montage,State=exports.State=Montage.create(Montage,{_stateChart:{enumerable:!1,value:null},init:{value:function(e){this.substates={},this.enterState=null,this.exitState=null;var t=Object.keys(e),n=0,r,i;for(;r=t[n];n++)i=e[r],i.prototype===State.prototype&&(i.name=r,i.parentState=this,this.substates[r]=i),typeof i=="string"&&"initialSubstate"!==r?this[r]=this._encloseGotoState(i):this[r]=i;return this}},name:{enumerable:!1,value:null},_initialSubstate:{enumerable:!1,value:null},initialSubstate:{get:function(){return typeof this._initialSubstate=="string"&&(this._initialSubstate=this[this._initialSubstate]),this._initialSubstate},set:function(e){this._initialSubstate=e}},substates:{enumerable:!1,value:null},parentState:{enumerable:!1,value:null},_path:{enumerable:!1,value:null},path:{enumerable:!1,get:function(){return this._path||(this.parentState&&this.parentState.path?this._path=this.parentState.path+"."+this.name:this._path=this.name),this._path}},enterState:{enumerable:!1,value:null},exitState:{enumerable:!1,value:null},isInState:{enumerable:!1,value:function(e){return typeof e!="string"&&(e=e.name),!!this.path.match(new RegExp(".?"+e+".?"))}},_encloseGotoState:{value:function(e){return function(t,n){return this._stateChart._gotoState(e,n)}}},gotoState:{value:function(e,t){return this._stateChart._gotoState(e,t)}},_performAction:{enumerable:null,value:function(e,t,n){if(this[e])this[e](t,n);else{if(!this.parentState)throw"Action '"+e+"' not available";this.parentState._performAction(e,t,n)}}},toString:{enumerable:!1,value:function(){return"[State "+this.path+" ]"}}}),StateChart=exports.StateChart=Montage.create(Montage,{delegate:{enumerable:!1,value:null},ownerStateProperty:{enumerable:!1,value:null},rootState:{enumerable:!1,value:null},_currentState:{enumerable:!1,value:null},currentState:{get:function(){return this.ownerStateProperty?null:this._currentState}},initWithState:{value:function(e){return this._states={},this.rootState=e,this.rootState._stateChart=this,this._prepareState(this.rootState),this.enterDefaultState(),this}},_defaultState:{enumerable:!1,value:null},defaultState:{enumerable:!1,get:function(){if(!this._defaultState){var e,t;e=t=this.rootState;while(t=t.initialSubstate)e=t;this._defaultState=e}return this._defaultState}},enterDefaultState:{enumerable:!1,value:function(){if(this.ownerStateProperty&&!this.owner)throw"This stateChart has been configured to require an owner to execute this function";var e=this.ownerStateProperty?this.owner:this,t=this.ownerStateProperty?e["_"+this.ownerStateProperty]:e.currentState;if(t)throw"Cannot enter default state from '"+t.name+"'";var n,r;n=r=this.rootState;while(r=r.initialSubstate)n.enterState&&n.enterState(this,e),n=r,r.initialSubstate&&n.exitState&&n.exitState(this,e);return this.ownerStateProperty?e["_"+this.ownerStateProperty]=this.defaultState:this._currentState=this.defaultState,this.defaultState}},_prepareState:{enumerable:!1,value:function(e){e._stateChart=this,e.name&&(this._states[e.name]=e);var t;for(t in e.substates)this._prepareState(e.substates[t])}},_states:{enumerable:!1,value:null},stateWithName:{enumerable:!1,value:function(e){return this._states[e]}},performAction:{value:function(e,t){if(this.ownerStateProperty&&!t)throw"This stateChart has been configured to require an owner to execute this function";t=this.ownerStateProperty?t:this;var n=this.ownerStateProperty?t[this.ownerStateProperty]:t.currentState;if(!n)throw"Cannot perform action '"+e+"' without a currentState";n._performAction(e,this,t),this.owner=null}},_gotoState:{value:function(e,t){if(this.ownerStateProperty&&!t)throw"This stateChart has been configured to require an owner to execute this function";t=this.ownerStateProperty?t:this;var n=this.ownerStateProperty?t[this.ownerStateProperty]:t.currentState,r=n.name,i=e,s,o,u,a,f,l,c,h,p,d,v,m=!1,g=!1,y=!1,b=!1;typeof i=="string"?e=this._states[e]:i=e.name;if(i===r)return;this.delegate&&(m=typeof this.delegate.stateChartWillExitState=="function",g=typeof this.delegate.stateChartWillEnterState=="function",y=typeof this.delegate.stateChartDidExitState=="function",b=typeof this.delegate.stateChartDidEnterState=="function");if(this.delegate&&typeof this.delegate.stateChartShouldGoFromStateToState=="function"&&!this.delegate.stateChartShouldGoFromStateToState(this,n,e))return;this.delegate&&typeof this.delegate.stateChartWillGoFromStateToState=="function"&&this.delegate.stateChartWillGoFromStateToState(this,n,e),s=n.path,o=e.path;if((new RegExp(s)).test(o)){a=o.replace(new RegExp(s+".?"),"").split("."),f=a.length,u=0;for(;u<f;u++)d=this._states[a[u]],g&&this.delegate.stateChartWillEnterState(this,d),typeof d.enterState=="function"&&d.enterState(this,t),b&&this.delegate.stateChartDidEnterState(this,d)}else{s=s.split("."),o=o.split("."),l=-1,h=o.length,p=Math.min(s.length,h);while(l<p){c=l+1;if(s[c]!==o[c])break;l++}for(u=s.length-1;u>l;u--)d=this._states[s[u]],m&&this.delegate.stateChartWillExitState(this,d),typeof d.exitState=="function"&&d.exitState(this,t),y&&this.delegate.stateChartDidExitState(this,d);l=l<0?0:l;for(u=l;u<h;u++)d=this._states[o[u]],g&&this.delegate.stateChartWillEnterState(this,d),this.ownerStateProperty?t["_"+this.ownerStateProperty]=d:this._currentState=d,typeof d.enterState=="function"&&d.enterState(this,t),b&&this.delegate.stateChartDidEnterState(this,d)}v=n,this.delegate&&typeof this.delegate.stateChartDidGoFromStateToState=="function"&&this.delegate.stateChartDidGoFromStateToState(this,v,e),typeof t.transitionedFromStateToState=="function"&&t.transitionedFromStateToState(this,v,e)}}})