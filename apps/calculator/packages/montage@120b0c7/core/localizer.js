var Montage=require("montage").Montage,MessageFormat=require("core/messageformat"),logger=require("core/logger").logger("localizer"),Serializer=require("core/serializer").Serializer,Deserializer=require("core/deserializer").Deserializer,Promise=require("core/promise").Promise,deserializeBindingToBindingDescriptor=require("core/event/binding").deserializeBindingToBindingDescriptor;MessageFormat.locale=require("core/messageformat-locale");var KEY_KEY="key",DEFAULT_MESSAGE_KEY="default",LOCALE_STORAGE_KEY="montage_locale",LOCALES_DIRECTORY="locale",MESSAGES_FILENAME="messages",MANIFEST_FILENAME="manifest.json",EMPTY_STRING_FUNCTION=function(){return""},reLanguageTagValidator=/^[a-zA-Z]+(?:-[a-zA-Z0-9]+)*$/,Localizer=exports.Localizer=Montage.create(Montage,{init:{value:function(e){return this.locale=e||defaultLocalizer.locale,this}},initWithMessages:{value:function(e,t){return this.locale=e,this.messages=t,this}},messageFormat:{serializable:!1,value:null},_messages:{value:null},messages:{get:function(){return this._messages},set:function(e){if(this._messages!==e){if(e!=null&&typeof e!="object")throw new TypeError(e," is not an object");this._messages=e}}},messagesPromise:{serializable:!1,value:null},_locale:{value:null},locale:{get:function(){return this._locale},set:function(e){if(!reLanguageTagValidator.test(e))throw new TypeError("Language tag '"+e+"' is not valid. It must match http://tools.ietf.org/html/rfc5646 (alphanumeric characters separated by hyphens)");this._locale!==e&&(this._locale=e,this.messageFormat=new MessageFormat(e))}},_availableLocales:{value:null},availableLocales:{get:function(){return this._availableLocales?this._availableLocales:this._availableLocales=this._manifest.get("files").get(LOCALES_DIRECTORY).get("files").then(function(e){return Object.keys(e)})}},_require:{value:typeof global!="undefined"?global.require:typeof window!="undefined"?window.require:null},require:{serializable:!1,get:function(){return this._require},set:function(e){this._require!==e&&(this.__manifest=null,this._require=e)}},__manifest:{value:null},_manifest:{depends:["require"],get:function(){var e=this.require;return e.packageDescription.manifest===!0?this.__manifest?this.__manifest:this.__manifest=e.async(MANIFEST_FILENAME):Promise.reject(new Error("Package has no manifest. "+e.location+'package.json must contain "manifest": true and '+e.location+MANIFEST_FILENAME+" must exist"))}},loadMessages:{value:function(e,t){if(!this.require)throw new Error("Cannot load messages as",this,"require is not set");e===null&&(e=5e3),this.messages=null;var n=this,r=this.require,i=this._manifest;return e&&(i=i.timeout(e)),this.messagesPromise=i.get("files").then(function(e){return n._loadMessageFiles(e)}).then(function(e){return n._collapseMessages(e)}).fail(function(e){throw console.error("Could not load messages for '"+n.locale+"': "+e),e}).then(function(e){return typeof t=="function"&&t(e),e})}},_loadMessageFiles:{value:function(e){var t=this.require;if(!e)return Promise.reject(new Error(t.location+MANIFEST_FILENAME+" does not contain a 'files' property"));var n,r=[],i,s,o;if(LOCALES_DIRECTORY in e){n=e[LOCALES_DIRECTORY].files,i=this._locale;while(i!=="")n.hasOwnProperty(i)&&(s=n[i].files,(o=MESSAGES_FILENAME+".js")in s||(o=MESSAGES_FILENAME+".json")in s?r.push(t.async(LOCALES_DIRECTORY+"/"+i+"/"+o)):logger.isDebug&&logger.debug(this,"Warning: '"+LOCALES_DIRECTORY+"/"+i+"/' does not contain '"+MESSAGES_FILENAME+".json' or '"+MESSAGES_FILENAME+".js'")),i=i.substring(0,i.lastIndexOf("-"));if(!r.length)return Promise.reject(new Error("Could not find any "+MESSAGES_FILENAME+".json or "+MESSAGES_FILENAME+".js files"));var u=Promise.all(r);if(logger.isDebug){var a=this;u=u.then(function(e){return logger.debug(a,"loaded "+e.length+" message files"),e})}return u}return Promise.reject(new Error("Package does not contain a '"+LOCALES_DIRECTORY+"' directory"))}},_collapseMessages:{value:function(e){var t={};for(var n=0,r=e.length;n<r;n++){var i=e[n];for(var s in i)s in t||(t[s]=i[s])}return this.messages=t,t}},_compiledMessageCache:{value:Object.create(null)},localizeSync:{value:function(e,t){var n,r,i;if(!e&&!t)throw new Error("Key or default message must be truthy, not "+e+" and "+t);if(this._messages&&e in this._messages){n=this._messages[e],r=typeof n;if(r==="function")return n;if(r==="object"){if(!("message"in n))throw new Error(n,"does not contain a 'message' property");n=n.message}}else n=t;n||(console.warn("No message or default message for key '"+e+"'"),n=e);if(n in this._compiledMessageCache)return this._compiledMessageCache[n];var s=this.messageFormat.parse(n);return s.program&&s.program.statements&&s.program.statements.length===1&&s.program.statements[0].type==="string"?(i=function(){return n},i.toString=i):i=(new Function("MessageFormat","return "+this.messageFormat.precompile(s)))(MessageFormat),this._compiledMessageCache[n]=i,i}},localize:{value:function(e,t,n,r){var i,s,o,u=this;n=typeof n=="undefined"?!0:n;if(!this.messagesPromise)return o=Promise.resolve(this.localizeSync(e,t)),o.then(r),o;var a=function(){var n=u.localizeSync(e,t);return typeof r=="function"&&r(n),n};return n?this.messagesPromise.then(a,a):this.messagesPromise.then(a)}}}),DefaultLocalizer=Montage.create(Localizer,{init:{value:function(){var e=this.callDelegateMethod("getDefaultLocale");return!e&&typeof window!="undefined"&&(window.localStorage&&(e=window.localStorage.getItem(LOCALE_STORAGE_KEY)),e=e||window.navigator.userLanguage||window.navigator.language),e=e||"en",this.locale=e,this.loadMessages().done(),this}},_delegate:{value:null},delegate:{get:function(){return this._delegate},set:function(e){this._delegate!==e&&(this._delegate=e,this.init())}},locale:{get:function(){return this._locale},set:function(e){try{Object.getPropertyDescriptor(Localizer,"locale").set.call(this,e)}catch(t){e="en",Object.getPropertyDescriptor(Localizer,"locale").set.call(this,e)}typeof window!="undefined"&&window.localStorage&&window.localStorage.setItem(LOCALE_STORAGE_KEY,e)}},reset:{value:function(){return typeof window!="undefined"&&window.localStorage&&window.localStorage.removeItem(LOCALE_STORAGE_KEY),this.init(),this._locale}}}),defaultLocalizer=exports.defaultLocalizer=DefaultLocalizer.create().init();exports.localize=defaultLocalizer.localize.bind(defaultLocalizer);var MessageData=Montage.create(Montage,{init:{value:function(e){for(var t in e)Object.defineBinding(this,t,{boundObject:e,boundObjectPropertyPath:t,oneway:!1});return this}},setProperty:{value:function(e,t){this.addPropertyChangeListener(e,this),Object.setProperty.call(this,e,t)}},handleChange:{value:function(e){this.dispatchEventNamed("change",!0,!1)}}}),Message=exports.Message=Montage.create(Montage,{didCreate:{value:function(){this._data=MessageData.create(),this._data.addEventListener("change",this,!1)}},init:{value:function(e,t,n){return e&&(this.key=e),t&&(this.defaultMessage=t),n&&(this.data=n),this}},_localizer:{value:defaultLocalizer},localizer:{get:function(){return this._localizer},set:function(e){if(this._localizer==e)return;this._localizer=e,this._localize()}},_key:{value:null},key:{get:function(){return this._key},set:function(e){if(this._key===e)return;this._key=e,this._localize()}},_defaultMessage:{value:null},defaultMessage:{get:function(){return this._defaultMessage},set:function(e){if(this._defaultMessage===e)return;this._defaultMessage=e,this._localize()}},_isLocalizeQueued:{value:!1},_localize:{value:function(){if(this._isLocalizeQueued)return;this._isLocalizeQueued=!0;var e=this,t=Promise.defer();this._messageFunction=t.promise,this.localized=this._messageFunction.then(function(t){return t(e._data)}),Promise.nextTick(function(){e._isLocalizeQueued=!1;if(!e._key&&!e._defaultMessage){console.warn("Both key and default message are falsey for",e,"If this is in a repetition this warning can be ignored"),t.resolve(EMPTY_STRING_FUNCTION);return}t.resolve(e._localizer.localize(e._key,e._defaultMessage))})}},_messageFunction:{value:Promise.resolve(EMPTY_STRING_FUNCTION)},_data:{value:null},data:{get:function(){return this._data},set:function(e){if(this._data===e)return;this._data&&this._data.removeEventListener("change",this),this._data=MessageData.create().init(e),this._data.addEventListener("change",this,!1),this.handleChange()}},__localizedResolved:{value:""},_localizedDeferred:{value:Promise.defer()},localized:{get:function(){return this._localizedDeferred.promise},set:function(e){if(e===this._localized)return;var t=this,n=Promise.defer();this._localizedDeferred.resolve(n.promise),e.then(n.resolve,n.reject),n.promise.then(function(e){return t.__localizedResolved=e}).done(),this._localizedDeferred=n}},setProperty:{value:function(e,t){e.indexOf("data.")===0&&this._data.addPropertyChangeListener(e.substring(5),this._data),Object.setProperty.call(this,e,t)}},handleChange:{value:function(e){this.localized=this._messageFunction.fcall(this._data)}},serializeSelf:{value:function(e){var t={_bindingDescriptors:this._bindingDescriptors};return t.key=this._key,t.defaultMessage=this._defaultMessage,this._localizer!==defaultLocalizer&&(t.localizer=this._localizer),t}},serializeForLocalizations:{value:function(e){var t={},n=this._bindingDescriptors;n&&n.key?t[KEY_KEY]=n.key:t[KEY_KEY]=this._key,n&&n.defaultMessage?t[DEFAULT_MESSAGE_KEY]=n.defaultMessage:t[DEFAULT_MESSAGE_KEY]=this._defaultMessage;var r=this._data._bindingDescriptors;for(var i in this._data)this._data.hasOwnProperty(i)&&(!r||!r[i])&&(t.data||(t.data={}),t.data[i]=this._data[i]);for(var s in r)t.data||(t.data={}),t.data[s]=r[s];return t}}}),createMessageBinding=function(e,t,n,r,i,s){var o=Message.create();for(var u in i)typeof i[u]=="string"?o.data[u]=i[u]:(deserializeBindingToBindingDescriptor(i[u],s),Object.defineBinding(o.data,u,i[u]));typeof n=="object"?(deserializeBindingToBindingDescriptor(n,s),Object.defineBinding(o,"key",n)):o.key=n,typeof r=="object"?(deserializeBindingToBindingDescriptor(r,s),Object.defineBinding(o,"defaultMessage",r)):o.defaultMessage=r,Object.defineBinding(e,t,{boundObject:o,boundObjectPropertyPath:"__localizedResolved",oneway:!0,serializable:!1})};Serializer.defineSerializationUnit("localizations",function(e){var t=e._bindingDescriptors;if(t){var n;for(var r in t){var i=t[r];if(Message.isPrototypeOf(i.boundObject)){n||(n={});var s=i.boundObject;n[r]=s.serializeForLocalizations()}}return n}}),Deserializer.defineDeserializationUnit("localizations",function(e,t,n){for(var r in t){var i=t[r],s,o;if(!(KEY_KEY in i)){console.error("localized property '"+r+"' must contain a key property ("+KEY_KEY+"), in ",t[r]);continue}logger.isDebug&&!(DEFAULT_MESSAGE_KEY in i)&&logger.debug(this,"Warning: localized property '"+r+"' does not contain a default message property ("+DEFAULT_MESSAGE_KEY+"), in ",e),s=i[KEY_KEY],o=i[DEFAULT_MESSAGE_KEY],createMessageBinding(e,r,s,o,i.data,n)}})