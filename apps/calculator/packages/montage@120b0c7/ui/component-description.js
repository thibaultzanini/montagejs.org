var Montage=require("montage").Montage,Enum=require("core/enum").Enum,Promise=require("core/promise").Promise,Selector=require("core/selector").Selector,Semantics=require("core/selector/semantics").Semantics,Serializer=require("core/serializer").Serializer,Deserializer=require("core/deserializer").Deserializer,logger=require("core/logger").logger("component-description"),ComponentDescription=exports.ComponentDescription=Montage.create(Montage,{_component:{serializable:!1,enumerable:!1,value:null},component:{get:function(){return this._component}},initWithComponent:{value:function(e){return this._component=e,this._component.description=this,this}},getComponentDescriptionFromComponentModule:{value:function(e){var t=Montage.getInfoForObject(e),n=t.moduleId,r=n.lastIndexOf("/"),i=n+"/"+n.slice(r===-1?0:r+1,-5)+"-description.json",s=Promise.defer();return t.require.async(i).then(function(n){Deserializer.create().initWithObjectAndRequire(n,t.require,i).deserializeObject(function(t){t?(t._component=e,s.resolve(t)):s.reject("No Component Description found "+i)},require)},s.reject),s.promise}},identifier:{get:function(){return[this.component.identifier,"description"].join("_")}},_componentPropertyDescriptions:{serializable:!0,enumerable:!1,distinct:!0,value:{}},componentPropertyDescriptions:{get:function(){var e=[],t;for(t in this._componentPropertyDescriptions)e.push(this._componentPropertyDescriptions[t]);return e}},componentPropertyDescriptionForName:{value:function(e){return this._componentPropertyDescriptions[e]}},addComponentPropertyDescription:{value:function(e){var t=this._componentPropertyDescriptions[e];return t==null&&(t=ComponentPropertyDescription.create().initWithPropertyAndComponentDescription(e,this),this._componentPropertyDescriptions[e]=t),t}},removeComponentPropertyDescription:{value:function(e){var t=this._componentPropertyDescriptions[e];return t!=null&&delete this._componentPropertyDescriptions[e],t}},_componentPropertyDescriptionGroups:{serializable:!0,enumerable:!1,distinct:!0,value:{}},componentPropertyDescriptionGroups:{get:function(){var e=[];for(var t in this._componentPropertyDescriptionGroups)e.push(t);return e}},componentPropertyDescriptionGroupForName:{value:function(e){var t=this._componentPropertyDescriptionGroups[e];return t!=null?t:[]}},addComponentPropertyDescriptionGroup:{value:function(e){var t=this._componentPropertyDescriptionGroups[e];return t==null&&(t=[],this._componentPropertyDescriptionGroups[e]=t),t}},removeComponentPropertyDescriptionGroup:{value:function(e){var t=this._componentPropertyDescriptionGroups[e];return t!=null&&delete this._componentPropertyDescriptionGroups[e],t}},addComponentPropertyDescriptionToGroup:{value:function(e,t){var n=this._componentPropertyDescriptionGroups[t];n==null&&(n=this.addComponentPropertyDescriptionGroup(t));var r=this._componentPropertyDescriptions[e];r==null&&(r=this.addComponentPropertyDescription(e));var i=n.indexOf(r);return i<0&&n.push(r),n}},removeComponentPropertyDescriptionFromGroup:{value:function(e,t){var n=this._componentPropertyDescriptionGroups[t],r=this._componentPropertyDescriptions[e];if(n!=null&&r!=null){var i=n.indexOf(r);i>=0&&n.splice(i,1)}return n!=null?n:[]}},_componentPropertyValidationRules:{serializable:!0,enumerable:!1,distinct:!0,value:{}},componentPropertyValidationRules:{get:function(){var e=[];for(var t in this._componentPropertyValidationRules)e.push(this._componentPropertyValidationRules[t]);return e}},componentPropertyValidationRuleForName:{value:function(e){return this._componentPropertyValidationRules[e]}},addComponentPropertyValidationRule:{value:function(e){var t=this._componentPropertyValidationRules[e];return t==null&&(t=ComponentPropertyValidationRule.create().initWithNameAndComponentDescription(e,this),this._componentPropertyValidationRules[e]=t),t}},removeComponentPropertyValidationRule:{value:function(e){var t=this._componentPropertyValidationRules[e];return t!=null&&delete this._componentPropertyValidationRules[e],t}},evaluateRules:{value:function(){var e=[];for(var t in this._componentPropertyValidationRules){var n=this._componentPropertyValidationRules[t];n.evaluateRule()&&e.push(n.messageKey)}return e}}}),ValueType=Enum.create().initWithMembers("string","number","boolean","date","enum","set","list","map","url","object"),ComponentPropertyDescription=exports.ComponentPropertyDescription=Montage.create(Montage,{_componentDescription:{serializable:!0,enumerable:!1,value:null},componentDescription:{get:function(){return this._componentDescription}},_name:{serializable:!0,enumerable:!1,value:""},name:{get:function(){return this._name}},initWithPropertyAndComponentDescription:{value:function(e,t){return this._name=e,this._componentDescription=t,this}},identifier:{get:function(){return[this.componentDescription.identifier,this.name].join("_")}},writable:{get:function(){return Montage.getPropertyProperty(this.componentDescription.component,this.name,"writable")}},serializable:{get:function(){return Montage.getPropertyProperty(this.componentDescription.component,this.name,"serializable")}},distinct:{get:function(){return Montage.getPropertyProperty(this.componentDescription.component,this.name,"distinct")}},_valueType:{serializable:!0,enumerable:!1,value:null},valueType:{serializable:!1,get:function(){return this._valueType===""?"string":this._valueType},set:function(e){this._valueType=e}},_enumValues:{serializable:!0,enumerable:!1,value:null},enumValues:{serializable:!1,get:function(){return this._enumValues?this._enumValues_enumValues:[]},set:function(e){Array.isArray(e)&&(this._enumValues=e)}},helpString:{serializable:!0,value:""}}),ComponentPropertyValidationRule=exports.ComponentPropertyValidationRule=Montage.create(Montage,{_componentDescription:{serializable:!0,enumerable:!1,value:null},componentDescription:{get:function(){return this._componentDescription}},identifier:{get:function(){return[this.componentDescription.identifier,"rule",this.name].join("_")}},_name:{serializable:!0,enumerable:!1,value:""},name:{get:function(){return this._name}},initWithNameAndComponentDescription:{value:function(e,t){return this._name=e,this._componentDescription=t,this}},_validationSelector:{enumerable:!1,value:null},validationSelector:{serializable:!1,get:function(){return this._validationSelector||(this._validationSelector=Selector.false),this._validationSelector},set:function(e){this._validationSelector=e}},_messageKey:{serializable:!0,enumerable:!1,value:""},messageKey:{serializable:!1,get:function(){return!this._messageKey||this._messageKey.length==0?ths._name:this._messageKey},set:function(e){this._messageKey=e}},_propertyValidationEvaluator:{serializable:!1,enumerable:!1,value:null},evaluateRule:{value:function(){if(_propertyValidationEvaluator===null){var e=PropertyValidationSemantics.create().initWithComponentDescription(this.componentDescription);_propertyValidationEvaluator=e.compile(this.selector.syntax)}return _propertyValidationEvaluator(this.componentDescription.component)}}}),PropertyValidationSemantics=exports.PropertyValidationSemantics=Semantics.create(Semantics,{_componentDescription:{serializable:!0,enumerable:!1,value:null},componentDescription:{get:function(){return this._componentDescription}},initWithComponentDescription:{value:function(e){return this._componentDescription=e,this}},compile:{value:function(e,t){Semantics.compile.call(self,e,t)}},operators:{value:{isBound:function(e){return!e}}},evaluators:{value:{isBound:function(e,t){var n=this;return function(r,i){var r=n.count(e(r,i));return t(r,i)}}}}});for(var name in Semantics.operators)PropertyValidationSemantics.operators[name]=Semantics.operators[name];for(var name in Semantics.evaluators)PropertyValidationSemantics.evaluators[name]=Semantics.evaluators[name]